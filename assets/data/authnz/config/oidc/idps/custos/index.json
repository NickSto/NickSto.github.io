{"hash":"c32ecfdb33b075b0057598b5b9118f3554a398cf","data":{"article":{"id":"70fa8d2713d0702a543b86186ff92ec3","title":"Configure Your Galaxy Instance as a Custos Client","tease":"","image":"","images":{},"category":null,"contact":"","date":null,"content":"<p><em>This page explains how to configure this feature as an administrator,\nfor user-specific docs, please refer to the <a href=\"/src/authnz/use/oidc/idps/custos/index.md\">Use page</a>.</em></p>\n<h1 id=\"about-custos\"><a href=\"#about-custos\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>About Custos</h1>\n<p><a href=\"https://airavata.apache.org/custos/\" target=\"_blank\" rel=\"noopener noreferrer\">Custos</a> is an <a href=\"https://www.nsf.gov/awardsearch/showAward?AWD_ID=1840003&#x26;HistoricalAwards=false\" target=\"_blank\" rel=\"noopener noreferrer\">NSF-funded\nproject</a>,\nbacked by open source software that provides science gateways such as Galaxy\nwith single sign-on, group management, and management of secrets such as access\nkeys and OAuth2 access tokens. With Galaxy, Custos allows users to login to\nGalaxy without having to (explicitly) create a Galaxy user account while being\nable to login choosing from more than 3,000 available Identity Providers\n(IdPs). Many of the academic institutions from around the world are supported\nallowing users to link their institutional identities with a Galaxy account.</p>\n<h1 id=\"configure-galaxy-to-work-with-custos\"><a href=\"#configure-galaxy-to-work-with-custos\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Configure Galaxy to work with Custos</h1>\n<p>To set up a Galaxy instance to work with Custos, it is necessary to enable\nOIDC-based login for Galaxy. To do this, follow the instructions for enabling\n<a href=\"/src/authnz/config/oidc/index.md#enable-oidc-based-login\">OIDC-based login</a>.\nNext, it is necessary to register your Galaxy instance as a client of Custos.\nThe following section demonstrates how to do that. Finally, you need to\nconfigure Custos as an IdP provider in Galaxy by editing\n<code>config/oidc_backends_config.xml</code>. An example file is provided below.</p>\n<h2 id=\"1-register-your-galaxy-instance-with-custos\"><a href=\"#1-register-your-galaxy-instance-with-custos\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>1. Register your Galaxy instance with Custos</h2>\n<p>Development of a portal for registering new Custos clients is currently in\nprogress. In the meantime, you can register a client directly through a REST\nAPI. This can be accomplished using a platform such as\n<a href=\"https://www.postman.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Postman</a>.</p>\n<p>To register a new Galaxy client with Custos, make a POST request with the\nfollowing body, replacing information with your relevant data:</p>\n<ul>\n<li>URI : <a href=\"https://custos.scigap.org:/apiserver/tenant-management/v1.0.0/oauth2/tenant\" target=\"_blank\" rel=\"noopener noreferrer\">https://custos.scigap.org:/apiserver/tenant-management/v1.0.0/oauth2/tenant</a></li>\n<li>Method : POST</li>\n<li>Body :\n<code>client_name:John Doe University requester_email:johndoe@university.edu admin_username:johndoe admin_first_name:John admin_last_name:Doe admin_email:johndoe@university.edu contacts:[1234567890] redirect_uris:[https://jduniversity.edu/galaxy/authnz/custos/callback] domain:jduniversity.edu admin_password:1234 client_uri:jduniversity.edu scope:email profile openId org.cilogon.userinfo application_type:web</code></li>\n</ul>\n<p>For example:\n<img src=\"/src/authnz/config/oidc/idps/custos/Custos-post-request.png\" alt=\"image\"></p>\n<ol>\n<li>The <em>Domain</em> should be the main address that users will use to get to your\ninstance of Galaxy.</li>\n<li>\n<p>For the <em>Redirect URIs</em> field, you need to enter\nyour instanceâ€™s OIDC redirect URI, which is in the following template:</p>\n<pre><code>&#x3C;Host URI>/authnz/custos/callback\n</code></pre>\n<p>For instance:</p>\n<pre><code>https://university.edu/galaxy/authnz/custos/callback\n</code></pre>\n<p>See <a href=\"/src/authnz/config/oidc/index.md#redirect-uri\">this section</a> for details.</p>\n</li>\n<li>After making the POST request, you should get a response containing your\n<code>Client ID</code> and <code>Client Secret</code>; note this info! You will need it for the\nGalaxy configuration.\n<img src=\"/src/authnz/config/oidc/idps/custos/Custos-post-request-response.png\" alt=\"image\"></li>\n<li>Finally, to have your client activated, send an email to\n<a href=\"mailto:custos@airavata.apache.org\" target=\"_blank\" rel=\"noopener noreferrer\">custos@airavata.apache.org</a> with your\n<code>Client ID</code>.</li>\n</ol>\n<h2 id=\"2-configure-galaxy\"><a href=\"#2-configure-galaxy\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>2. Configure Galaxy</h2>\n<p>Once we have an activated client ID and client secret from Custos, we need to\nconfigure Galaxy. As a first step, make sure to <a href=\"/src/authnz/config/oidc/#enable-oidc-based-login\">enable OIDC\nlogin</a>. After setting up\n<code>config/oidc_config.xml</code>, which is common to multiple IdPs, you need to\nconfigure <code>config/oidc_backends_config.xml</code>. The following is an example of a\nconfiguration. Note that the <strong>redirect_uri</strong> must match what as included as\nthe callback URL during your Custos client registration. Also note that\n<code>localhost</code> and <code>127.0.0.1</code> are not the same; if you register <code>127.0.0.1</code> and\naccess your Galaxy via <code>localhost</code>, the redirect will not work. The client ID\nand client secret are unique to your installation of Galaxy and were obtained\nduring client registration.</p>\n<pre><code class=\"language-xml\">&#x3C;?xml version=\"1.0\"?>\n&#x3C;OIDC>\n    &#x3C;provider name=\"Custos\">\n        &#x3C;url>https://custos.scigap.org/apiserver/identity-management/v1.0.0/&#x3C;/url>\n        &#x3C;client_id>custos-xmn3092m8tkh7546hv76-10000001&#x3C;/client_id>\n        &#x3C;client_secret>15Ur37stVGwvONALNjjq89ezRXxoKuunFzvEeTDY&#x3C;/client_secret>\n        &#x3C;redirect_uri>http://jduniversity.edu/galaxy/authnz/custos/callback&#x3C;/redirect_uri>\n    &#x3C;/provider>\n&#x3C;/OIDC>\n</code></pre>\n<p>The above configuration includes the <a href=\"/src/authnz/config/oidc/#oidc-configuration-options-for-identity-providers\">default OIDC configuration\ntags</a>\nas we as the required <code>url</code> tag.</p>\n<h3 id=\"url\"><a href=\"#url\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>URL</h3>\n<p>The <code>url</code> tag is a required Custos configuration. It provides a unique url\nfor the Custos service. The hosted public Custos service is available at the\nURL included in the sample configuration above.</p>\n<h3 id=\"ca-bundle\"><a href=\"#ca-bundle\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>CA bundle</h3>\n<p>The <code>ca_bundle</code> tag is optional. The value for this tag is an absolute path\nto a trusted CA certificate file or directory to use when verifying Custos\nauthorization server. If this option is used, it is also necessary to set the\nvalue of <code>VERIFY_SSL</code> to <code>True</code> in <code>oidc_config.xml</code>.</p>\n<h3 id=\"well-known-oidc-config-uri\"><a href=\"#well-known-oidc-config-uri\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Well-known OIDC config URI</h3>\n<p>The <code>well_known_oidc_config_uri</code> tag is optional and allows you to override the\ndefault Custos well-known URL to point to a different instance.</p>\n<h3 id=\"enable-idp-logout\"><a href=\"#enable-idp-logout\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Enable IdP logout</h3>\n<p>The <code>enable_idp_logout</code> is an optional boolean tag. If set, Galaxy will log out\nthe user from the IdP (eg, if a user used Google so authenticate, the user will\nbe logged out of Google as well as Galaxy). For this option to work, the\n<code>redirect_url</code> during the <a href=\"#1-register-your-galaxy-instance-with-custos\">client registration\nabove</a> needs to specify a wild\ncard instead of the specific path (eg, <code>https://jduniversity.edu/galaxy/*</code>).</p>\n<h2 id=\"3-restart-galaxy\"><a href=\"#3-restart-galaxy\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>3. (re)Start Galaxy</h2>\n<p>Having set this configuration, (re)start Galaxy and the <code>Sign in with Custos</code>\nfeature will become available. The login page should look as follows:</p>\n<div class=\"center\">\n    <img src=\"/src/authnz/config/oidc/idps/custos/custos-login-button2.png\"\n     alt=\"User login with Custos enabled\" width=\"60%\" />\n</div>\n<p>For the end-user documentation of how to use the Custos login now that it has\nbeen configured, take a look at the\n<a href=\"/src/authnz/use/oidc/idps/custos/index.md\">end-user</a> page.</p>\n"}},"context":{}}