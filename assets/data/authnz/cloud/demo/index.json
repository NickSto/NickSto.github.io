{"hash":"c32ecfdb33b075b0057598b5b9118f3554a398cf","data":{"article":{"id":"82edb26302a7e978002b789e62ff9c27","title":"Cloud Authorization Demo","tease":"","image":"","images":{},"category":null,"contact":"","date":null,"content":"<p>Here we demo copying an object from an AWS S3 bucket to a Galaxy history.\nFor this:</p>\n<ul>\n<li>we copy the <code>ENCFF001SNN.broadPeak.gz</code> object from\n<a href=\"https://registry.opendata.aws/encode-project/\" target=\"_blank\" rel=\"noopener noreferrer\">ENCODE's AWS S3 bucket</a>;</li>\n<li>to gain access to the <code>ENCFF001SNN.broadPeak.gz</code> object, we\nuse a role created by the Galaxy project for the purpose of this demo;</li>\n<li>we use a pre-bake branch of Galaxy with all the necessary configuration\npre-setup. </li>\n</ul>\n<div class=\"alert alert-info\" role=\"alert\">\n    Note: all the features described here are under active developement,\n    and this demo only shows their current status. Once all the necessary \n    components are developed, this feature will be available from \n    [Galaxy Main](https://usegalaxy.org).\n</div>\n<p>For this demo, we first start a local Galaxy instance, then login to\nthat instance, and define a cloud authorization record, which we will\nthen use to copy the <code>ENCFF001SNN.broadPeak.gz</code> object. </p>\n<p>You may take the following steps:</p>\n<ol>\n<li>\n<p>Clone a pre-baked instance of Galaxy by running the following\ncommand in your terminal: </p>\n<pre><code>```bash\nmkdir ~/role_demo &#x26;&#x26; cd ~/role_demo &#x26;&#x26; git clone -b aws_demo_role https://github.com/vjalili/galaxy .\n```\n</code></pre>\n</li>\n<li>\n<p>Start Galaxy by running the following command:</p>\n<pre><code class=\"language-bash\">./run.sh\n</code></pre>\n<p>wait until you see the following message:</p>\n<pre><code class=\"language-bash\">serving on http://127.0.0.1:8080\n</code></pre>\n</li>\n<li>\n<p>Login to your Galaxy instance by clicking on the <code>Login or Register</code>\nbutton, and then on the <code>Sign in with Google</code> button:</p>\n<pre><code>![image](/src/authnz/cloud/demo/01.png)\n</code></pre>\n</li>\n<li>\n<p>Enter your Google credentials if required:</p>\n<p><img src=\"/src/authnz/cloud/demo/02.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Having signed-in with your Google credentials, you will be auto-redirected\nback to your local installation of Galaxy; then click on the <code>User</code> button\nand choose the <code>Preferences</code> menu item:</p>\n<pre><code>![image](/src/authnz/cloud/demo/03.png) \n</code></pre>\n</li>\n<li>\n<p>From the preferences menu, choose the <code>Manage Cloud Authorization</code> option:</p>\n<p><img src=\"/src/authnz/cloud/demo/04.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Click on the <code>Create New Authorization Key</code>, and enter the following value for\nthe <code>Role ARN</code> field, and click on the <code>Save Key</code> button.</p>\n<pre><code>```\narn:aws:iam::347162595075:role/Authnz_demo_role\n```\n\n![image](/src/authnz/cloud/demo/05.png)\n</code></pre>\n</li>\n<li>\n<p>Click on the <code>User</code> button, and choose <code>Preferences</code>, and from the\n\"User Preferences\" menu, choose <code>Manage API key</code>:</p>\n<pre><code>![image](/src/authnz/cloud/demo/06.png)\n</code></pre>\n</li>\n<li>\n<p>Click on the <code>Create a new key</code>, and copy API key:</p>\n<p><img src=\"/src/authnz/cloud/demo/07.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Keep the terminal running your Galaxy open, and open a new terminal\nand run the following command where <code>[API KEY]</code> is your API obtained\nat previous step: </p>\n<pre><code>```bash\npython get_object.py [API KEY]\n```\n\nRunning this command will return a list as the following which indicates\nthat a Galaxy has create a job to download the `ENCFF001SNN.broadPeak.gz` \nobject: \n\n```bash\nvahid$ python get_object.py 76e948f7c9f858612abab98df7f75ddb\n[{u'update_time': u'2019-04-26T23:30:42.061336', u'uuid': u'a3404949-dbf3-4657-999d-11837e5c7f3f', u'deleted': False, u'id': u'1cd8e2f6b131e891', u'purgable': True, u'total_size': 0, u'state': u'queued', u'create_time': u'2019-04-26T23:30:42.002358', u'file_size': 0, u'purged': False}]\n```\n</code></pre>\n</li>\n<li>\n<p>At this point Galaxy has downloaded the object to your history:</p>\n<p><img src=\"/src/authnz/cloud/demo/08.png\" alt=\"image\"></p>\n</li>\n</ol>\n<h1 id=\"remarks\"><a href=\"#remarks\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Remarks</h1>\n<p>The policy of the <code>Authnz_demo_role</code> role that we set this Galaxy instance\nto assume, is defined as the following:</p>\n<pre><code class=\"language-json\">{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"VisualEditor0\",\n            \"Effect\": \"Allow\",\n            \"Action\": \"s3:GetObject\",\n            \"Resource\": \"arn:aws:s3:::encode-public/2008/11/24/034e3689-9903-4c86-9237-040f8f795b73/ENCFF001SNN.broadPeak.gz\"\n        }\n    ]\n}\n</code></pre>\n<p>Accordingly, this role grants the local Galaxy instance with read access\n(<code>\"Action\": \"s3:GetObject\"</code>) to only one object, i.e.,\n<code>arn:aws:s3:::encode-public/2008/11/24/034e3689-9903-4c86-9237-040f8f795b73/ENCFF001SNN.broadPeak.gz</code></p>\n<p>Additionally, the trust relation of this role is defined as the following:</p>\n<pre><code class=\"language-json\">{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Federated\": \"accounts.google.com\"\n      },\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"accounts.google.com:aud\": \"893677542423-4t761afe33k3o9mu56u6p6p1ctk8o88f.apps.googleusercontent.com\"\n        }\n      }\n    }\n  ]\n}\n</code></pre>\n<p>Accordingly, only the Galaxy instance with the OpenID Connect Audience ID\n<code>893677542423-4t761afe33k3o9mu56u6p6p1ctk8o88f.apps.googleusercontent.com</code>\nthat is registered with Google (<code>\"Federated\": \"accounts.google.com\"</code>) can\nassume this role. See <a href=\"/src/authnz/config/oidc/idps/google/index.md\">this page</a>\non how to register your Galaxy; however, for the purpose of this demo,\nthe pre-baked Galaxy that you cloned is already registered with Google.</p>\n<div class=\"alert alert-info\" role=\"alert\">\n    Note: the OIDC audience ID and secret of the Galaxy instance shared\n    with you, shall be used for the purpose of this demo only.\n</div>\n"}},"context":{}}