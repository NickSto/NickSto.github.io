{"hash":"c32ecfdb33b075b0057598b5b9118f3554a398cf","data":{"article":{"id":"0e8557596435f07d4d88fa18e6f0269c","title":"Configure Cloud Authorization for GCP","tease":"","image":"","images":{},"category":null,"contact":"","date":null,"content":"<p>To authorize Galaxy to establish a connection to your Google Cloud\nPlatform (GCP) account, you would need to create a GCP\n<a href=\"https://cloud.google.com/iam/docs/service-accounts\" target=\"_blank\" rel=\"noopener noreferrer\"><em>service account</em></a>\nand provide Galaxy with its secrets. This page briefly explains\nhow to create a service account, obtain its credentials, and present\nthem to Galaxy.</p>\n<h1 id=\"step-1-create-a-gcp-service-account\"><a href=\"#step-1-create-a-gcp-service-account\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Step 1: Create a GCP Service Account</h1>\n<p>In the following we explain how to create a GCP service account\nusing GCP <code>console</code> graphical interface; you may refer to\n<a href=\"https://cloud.google.com/iam/docs/creating-managing-service-accounts\" target=\"_blank\" rel=\"noopener noreferrer\">GCP documentation page</a>.</p>\n<p>In general, first we create a service account, then\nwe grant the service account with required permissions,\nand then we download a file that contains all the secrets\nto assume the role. To do so, take the following steps:</p>\n<ol>\n<li>\n<p>Goto <a href=\"https://console.cloud.google.com/iam-admin/serviceaccounts?_ga=2.118918286.-66625773.1542049771\" target=\"_blank\" rel=\"noopener noreferrer\"><code>Service Accounts Page</code></a>:</p>\n<p><img src=\"/src/authnz/cloud/gcp/01.png\" alt=\"image\"> </p>\n<p>Click on the <code>Select a project</code> button and choose a project\nthat you would like to authorize Galaxy to authorize access its\nresources. If you do not have a project,\n<a href=\"https://cloud.google.com/resource-manager/docs/creating-managing-projects\" target=\"_blank\" rel=\"noopener noreferrer\">refer to this page</a>\non how to create one.</p>\n</li>\n<li>\n<p>Click on the  <code>+ CREATE SERVICE ACCOUNT</code> button:</p>\n<p><img src=\"/src/authnz/cloud/gcp/02.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Fill in the detail and click on the <code>CREATE</code> button:</p>\n<p><img src=\"/src/authnz/cloud/gcp/03.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Grant the service account with minimum required permissions, then click\non the <code>CONTINUE</code> button:</p>\n<p><img src=\"/src/authnz/cloud/gcp/04.png\" alt=\"image\"></p>\n<p>To define a more granular roles (with least possible privileges), you may\nfirst <a href=\"https://cloud.google.com/iam/docs/granting-roles-to-service-accounts\" target=\"_blank\" rel=\"noopener noreferrer\">refer to this page</a>\nfor details on granting roles to service accounts, and then\n<a href=\"https://cloud.google.com/iam/docs/understanding-roles\" target=\"_blank\" rel=\"noopener noreferrer\">refer to this list</a>\nof roles for choosing a role that satisfies you authorization needs at best.</p>\n</li>\n<li>\n<p>Click on the <code>+ CREATE KEY</code> button, and then choose <code>JSON</code> (the default option)\nfrom the newly shown window, then click on the <code>CREATE</code> button.</p>\n<p><img src=\"/src/authnz/cloud/gcp/05.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>A file containing the secrets for the service account will be then downloaded\nto your computer:</p>\n<p><img src=\"/src/authnz/cloud/gcp/06.png\" alt=\"image\"></p>\n</li>\n<li>Click on the <code>CLOSE</code> and then <code>DONE</code> buttons. </li>\n</ol>\n<h1 id=\"step-2-provide-galaxy-with-the-service-account-secrets\"><a href=\"#step-2-provide-galaxy-with-the-service-account-secrets\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Step 2: Provide Galaxy with the Service Account Secrets</h1>\n<p>We use Galaxy's cloud authorization API to define authorization to GCP.\nIn general, first we obtain an API key, then <code>POST</code> required info to the\ncloud authorization API. For this, take the following steps:</p>\n<ol>\n<li>\n<p>Login to Galaxy (<a href=\"https://galaxyproject.org/authnz/\" target=\"_blank\" rel=\"noopener noreferrer\">different methods are available</a>, including\n<a href=\"https://galaxyproject.org/authnz/use/oidc/idps/google/\" target=\"_blank\" rel=\"noopener noreferrer\">login with Google</a> account),\nthen go to the <code>Preferences</code> section:</p>\n<pre><code>![image](/src/authnz/cloud/gcp/07.png)\n</code></pre>\n</li>\n<li>\n<p>In the <code>User preferences</code> window, click on the <code>Manage API key</code> item,\nthen click on the <code>Create a new key</code> button, and copy the generated API key:</p>\n<pre><code>![image](/src/authnz/cloud/gcp/08.png)\n</code></pre>\n</li>\n<li>\n<p>Send a <code>POST</code> request to cloud authorization API at: </p>\n<pre><code>api/cloud/authz\n</code></pre>\n<p>with the following payload:</p>\n<pre><code class=\"language-json\">{\n  \"provider\": \"gcp\",\n  \"authn_id\":\"f2db41e1fa331b3e\",\n  \"config\": {\n    \"project_id\": \"...\",\n    \"private_key_id\": \"...\",\n    \"private_key\": \"...\",\n    \"client_email\": \"...\",\n    \"client_id\": \"...\"\n  }\n}\n</code></pre>\n<p>You may send a <code>GET</code> request to <code>/authnz</code> controller to obtain the <code>authn_id</code>.\nYou may obtain the values for the keys in the <code>config</code> section, from the service\naccount's secretes file downloaded from GCP at first step.</p>\n<p>Galaxy will respond to the <code>POST</code> method as the following:</p>\n<pre><code class=\"language-json\">{\n    \"authn_id\": \"f2db41e1fa331b3e\",\n    \"user_id\": \"f2db41e1fa331b3e\",\n    \"description\": \"\",\n    \"last_update\": \"2019-07-15 21:59:26.171779\",\n    \"last_activity\": \"2019-07-15 21:59:26.171791\",\n    \"create_time\": \"2019-07-16 04:59:26.173277\",\n    \"provider\": \"gcp\",\n    \"model_class\": \"CloudAuthz\",\n    \"config\": {\n        \"private_key\": \"...\",\n        \"project_id\": \"...\",\n        \"client_email\": \"...\",\n        \"private_key_id\": \"...\",\n        \"client_id\": \"...\"\n    },\n    \"id\": \"f2db41e1fa331b3e\"\n}\n</code></pre>\n<p>Take a note of the authorization ID (i.e., <code>\"id\": \"f2db41e1fa331b3e\"</code>), which you would need\nto provide in order to interact with GCP. Having defined the cloud authorization, you may\n<a href=\"/src/cloud/storage/#send-data-to-cloud\">send your data from Galaxy to Google Cloud Storage (GCS)</a>,\nor <a href=\"/src/cloud/storage/#get-data-from-cloud\">copy your data from GCS to your Galaxy history</a>.</p>\n</li>\n</ol>\n"}},"context":{}}