{"hash":"fe50d2d58b71effa03c01b08cdaab48b91e9d3d3","data":{"article":{"id":"04066cfa85da9b3412231d117081404e","title":"","tease":"","category":null,"date":null,"days":null,"contact":"","contact_url":"","authors":"","location":"","location_url":"","source_blog":"","source_blog_url":"","skip_title_render":null,"links":[],"image":"","images":{},"external_url":"","content":"<div class=\"toc-wrapper col-md-3\">\n<ul>\n<li><a href=\"#data-providers\">Data Providers</a></li>\n<li>\n<p><a href=\"#how-to-get-data-using-dataproviders\">How to get data using DataProviders</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#datatypedataprovider\">datatype.dataprovider</a></li>\n<li><a href=\"#the-datasets-api\">The datasets API</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#how-to-filter-and-format-data-using-dataproviders\">How to filter and format data using DataProviders</a></li>\n<li>\n<p><a href=\"#how-to-define-a-new-dataprovider\">How to define a new DataProvider</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#adding-a-provider-to-a-datatype\">Adding a provider to a datatype</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</div>\n<div class=\"body-wrapper col-md-9\">\n<h2 id=\"data-providers\"><a href=\"#data-providers\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Data Providers</h2>\n<p><a href=\"/data-providers/\">DataProviders</a> are a framework for easily controlling how data can be provided from a source\n(generally, a dataset's file contents). They are meant to be:</p>\n<ol>\n<li>Simple to declare, configure, and associate with some source of data.</li>\n<li>Maintain simplicity by allowing piping - sending one provider through one or more others until a final, desired format/query is provided.</li>\n<li>Be fast and efficient by allowing narrow queries that provide only specified amounts of data from specified locations.</li>\n</ol>\n<p>They are <em>not</em> meant to be:</p>\n<ol>\n<li>Replacements for the tools and workflows through which Galaxy provides reproducibility.</li>\n<li>Writable in any sense. They can't alter the original data in any permanent fashion.</li>\n</ol>\n<p>Essentially, they are meant to be a 'view' of your data and not the data themselves.</p>\n<p>Currently, data providers are only available for the file contents of a dataset.</p>\n<p>For more examples than are on this page, see <a href=\"/data-providers/cookbook/\">DataProviders/Cookbook</a>.</p>\n<hr>\n<h2 id=\"how-to-get-data-using-dataproviders\"><a href=\"#how-to-get-data-using-dataproviders\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>How to get data using DataProviders</h2>\n<p>Currently, there are two entry points to data providers for datasets:</p>\n<ul>\n<li>Programmtically (typically in a visualization template or other python script) by calling a datatype's <code>dataprovider</code>\nmethod and passing in (at a minimum) the dataset and the name of a particular format/dataprovider</li>\n<li>Via the datasets API (which itself calls the <code>dataprovider</code> method)</li>\n</ul>\n<h4 id=\"datatypedataprovider\"><a href=\"#datatypedataprovider\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>datatype.dataprovider</h4>\n<p>If a datatype does not have the provider assigned to the given name, an error is raised. If it does, any additional\nparameters to the method are parsed and a python generator is returned. This generator will yield individual data\nbased on the type of provider (and the additional arguments).</p>\n<p>For example, given dataset contents in a tabular file called 'dataset1':</p>\n<pre><code># yet another data format\n1   10  11  110\n2   20  22  220\n\n3   30  33  330\n</code></pre>\n<p>within a visualization template or python script, one could get each line as an array of columnar data by calling:</p>\n<pre><code class=\"language-python\">for array in dataset1.datatype.dataprovider( dataset1, 'column' ):\n    print array\n# [ \"1\", \"10\", \"11\", \"110\" ]\n# [ \"2\", \"20\", \"22\", \"220\" ]\n# [ \"3\", \"30\", \"33\", \"330\" ]\n</code></pre>\n<p>Note: When using text file datatypes, both comments (lines beginning with '#' - although this is configurable) and\nblank lines are stripped from the output.</p>\n<p>Pass in additional arguments to filter or configure output by adding keyword arguments to the provider. For example,\nto limit the above to only two lines and offset by one line:</p>\n<pre><code class=\"language-python\">for array in dataset1.datatype.dataprovider( dataset1, 'column', limit=2, offset=1 ):\n    print array\n# [ \"2\", \"20\", \"22\", \"220\" ]\n# [ \"3\", \"30\", \"33\", \"330\" ]\n</code></pre>\n<p>To have the server parse the contents as numbers:</p>\n<pre><code class=\"language-python\">types = [ 'int', 'float', 'int', 'float' ]\nfor array in dataset1.datatype.dataprovider( dataset1, 'column', column_types=types ):\n    print array\n# [1, 10.0, 11, 110.0]\n# [2, 20.0, 22, 220.0]\n# [3, 30.0, 33, 330.0]\n</code></pre>\n<h4 id=\"the-datasets-api\"><a href=\"#the-datasets-api\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>The datasets API</h4>\n<p>You can access data providers for a dataset via the datasets API by passing the provider name as an argument (for more\ninformation on how to use the API see <a href=\"/learn/api/\">Learn/API</a>).</p>\n<pre><code class=\"language-bash\">curl 'http://localhost:8080/api/datasets/86cf1d3beeec9f1c?data_type=raw_data&#x26;provider=column&#x26;limit=2&#x26;offset=1&#x26;api_key=cf8245802b54146014108216e815d6e4'\n{\n    \"data\": [\n        [\n            \"2\",\n            \"20\",\n            \"22\",\n            \"220\"\n        ],\n        [\n            \"3\",\n            \"30\",\n            \"33\",\n            \"330\"\n        ]\n    ]\n}\n</code></pre>\n<p>Note: that the API returns a <a href=\"http://www.json.org/\" target=\"_blank\" rel=\"noopener noreferrer\">JSON</a> formatted object and the array of data is an attribute of\nthat object named 'data'. This allows the API to send additional information (such as number of datapoints, metadata,\naggregate information, etc.) as other attributes if needed.</p>\n<p>Commonly, the API will be accessed by a javascript client (e.g. the browser window in a visualization). For example,\ngetting data through the API with <a href=\"http://jquery.com/\" target=\"_blank\" rel=\"noopener noreferrer\">jQuery</a>:</p>\n<pre><code class=\"language-javascript\">var xhr = jQuery.getJSON( \"/api/datasets/86cf1d3beeec9f1c\", {\n    data_type : 'raw_data',\n    provider  : 'column',\n    limit     : 2,\n    offset    : 1\n});\nxhr.done( function( response ){\n    console.debug( response.data );\n    // [[\"2\", \"20\", \"22\", \"220\"], [\"3\", \"30\", \"33\", \"330\"]]\n    // ...do something with data\n});\n</code></pre>\n<p>There are many data providers included in Galaxy already.</p>\n<p>For all formats:</p>\n<ul>\n<li>base:    reads directly from the file without any formating or filtering</li>\n<li>chunk:   allows breaking file contents into sections of <code>chunk_size</code> bytes and offsetting using <code>chunk_index</code></li>\n<li>chunk64: as chunk, but encodes each section using base64 encoding</li>\n</ul>\n<p>For text based formats:</p>\n<ul>\n<li>line:    reads each line from a file, allowing limit, offset, filter functions (in python), removes blank lines,\nremoves commented lines, strips whitespace from beginning and end of lines (all configurable)</li>\n<li>regex-line: as 'line' provider above also allowing <code>regex_list</code>, a list of python regex strings. If a line matches\none or more of the regex expressions in <code>regex_list</code>, the line is output. Also allows inverting the match using\n<code>invert</code>.</li>\n</ul>\n<p>For tabular formats:</p>\n<ul>\n<li>\n<p>column:  lines are returned as arrays of column data (as above). Many options are available for this provider\nincluding:</p>\n<ul>\n<li>indeces: return only the columns specified by a 0-based, comma separated list of integers (e.g. '0,2,5')</li>\n<li>column_count: return only the first N columns from each line</li>\n<li>deliminator: defaults to the tab character but can be used to parse comma separated data as well</li>\n<li>column_types: a CSV string of python primitive names used to parse each column (e.g. 'str,int,float,bool').\nCan works in tandem with indeces to parse only those columns requested.</li>\n</ul>\n</li>\n<li>dict:    return each line as a dictionary. Keys used should be sent as <code>column_names</code>, a CSV list of strings\n(e.g. column_names='id,start,end'). Based on the <code>column</code> provider and allows all options used there.</li>\n</ul>\n<p>Dataset specific providers for text and tabular formats:</p>\n<ul>\n<li>You'll often see these used in the built-in providers (e.g. those found in <code>datatypes/tabular.py</code>). They attempt\nto infer the proper column settings for other providers by using a dataset's metadata (column names, types, etc.)</li>\n<li>dataset-column: as the column provider, but infers <code>column_types</code> from metadata (for easier parsing)</li>\n<li>dataset-dict: as the dict provider, but infers <code>column_names</code> from metadata. Names can be overridden by\nstill passing in <code>column_names</code>.</li>\n</ul>\n<p>For interval datatypes:</p>\n<ul>\n<li>genomic-region and genomic-region-dict: parses and returns chromosome, start, and end data as arrays or dictionaries\nrespectively.</li>\n<li>interval and interval-dict: as genomic-region, but also returns strand and name if set in the metadata.</li>\n</ul>\n<p>Other providers can be found within the datatype class definitions for datatypes included in Galaxy.</p>\n<hr>\n<h2 id=\"how-to-filter-and-format-data-using-dataproviders\"><a href=\"#how-to-filter-and-format-data-using-dataproviders\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>How to filter and format data using DataProviders</h2>\n<p>Although still a work in progress, you can use several aspects of existing data providers to easily filter data both\nwith python or through the API.</p>\n<p>Python is currently the more powerful option. For example, in a visualization template one could pass a filter\nfunction to a 'genomic-region-dict' provider:</p>\n<pre><code class=\"language-python\">def position_within_point( self, datum ):\ndef filter_chr10( datum ):\n    chr = datum.split( '\\t' )[0]\n    if chr == 'chr10':\n        return datum\n    return None\nfor region in hda.datatype.dataprovider( hda, 'genomic-region-dict', limit=2, offset=1, filter_fn=filter_chr10 ):\n    print region\n# {'start': 180404, 'end': 300577, 'chrom': 'chr10'}\n# {'start': 180423, 'end': 295729, 'chrom': 'chr10'}\n</code></pre>\n<p>Through the API, (currently) the easiest way is to use the <code>regex_list</code> argument:</p>\n<pre><code class=\"language-javascript\">var xhr = jQuery.getJSON( \"/api/datasets/86cf1d3beeec9f1c\", {\n    data_type : 'raw_data',\n    provider  : 'genomic-region-dict',\n    limit     : 2,\n    offset    : 1,\n    regex_list : '^chr10\\\\b'\n});\nxhr.done( function( response ){\n    console.debug( response.data );\n    // [Object { chrom=\"chr10\", end=300577, start=180404}, Object { chrom=\"chr10\", end=295729, start=180423}]\n});\n</code></pre>\n<p>(Note: the double slash escaping of '\\b' which allows us to send the regex with a proper, final '\\b' and not the\nascii bell character)</p>\n<p>For more filters, see: <a href=\"/data-providers/cookbook/#no2c_i_want_to_filter_my_data_using_a_calculation_-_not_regex\">Filtering using calculations</a>\nin the cookbook.</p>\n<hr>\n<h2 id=\"how-to-define-a-new-dataprovider\"><a href=\"#how-to-define-a-new-dataprovider\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>How to define a new DataProvider</h2>\n<p>Since data providers are nothing more than fancy python generators, there are three ways to create a new data provider:</p>\n<ul>\n<li>Create a new DataProvider class and inherit from an existing provider and modify it's methods</li>\n<li>Instantiate an existing provider and pipe its output into a new generator</li>\n<li>Hardcode or override the option arguments available for an existing provider (e.g. create a csv column provider by\nwrapping the column provider with <code>deliminator=','</code>)</li>\n</ul>\n<p>It's also possible to create a provider outside the datatypes - for instance, inside a script or visualization template.</p>\n<h4 id=\"adding-a-provider-to-a-datatype\"><a href=\"#adding-a-provider-to-a-datatype\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Adding a provider to a datatype</h4>\n<p>In general, data providers will most often be associated with a dataset datatype. Since it's also common that new\ntool installations can have datatype definitions, we wanted it to be easy to define new data providers for those\ndatatypes.</p>\n<p>Within your datatype (or an existing one), create a method that returns an instance of your data provider. Decorate\nthe method with <code>dataproviders.decorators.dataprovider_factory</code> and give that decorator the name of your provider\n(e.g. 'column') and a dictionary of the settings you want the provider to use. The name should be unique to prevent\ncollision with other existing providers.</p>\n<p>Let's say we've defined a datatype that is CSV and has 20 columns of data. We'd like to provide the same format for\ndata that the GenomicRegionDataProvider does (chrom, start, end) so we'll implement a provider to get that same\ndata from our datatype:</p>\n<pre><code class=\"language-python\">from galaxy.datatypes import tabular\nfrom galaxy.datatypes import dataproviders\nfrom galaxy.datatypes.dataproviders.dataset import GenomicRegionDataProvider\n# ...\n\n@dataproviders.decorators.has_dataproviders\nclass MyDatatype( tabular.Tab ):\n    # a datatype that for some reason is ordered as: end_position, start_position, chromosome_id\n    # ...\n    @dataproviders.decorators.dataprovider_factory( 'genomic-region-dict', GenomicRegionDataProvider.settings )\n    def overlap_dataprovider( self, dataset, **settings ):\n        dataset_source = dataproviders.dataset.DatasetDataProvider( dataset )\n        settings[ 'deliminator' ] = ','\n        settings[ 'indeces' ] = [ 4, 8, 9 ]\n        settings[ 'column_names' ] = [ 'chrom', 'start', 'end' ]\n        return GenomicRegionDataProvider( dataset_source, **settings )\n</code></pre>\n<p>Note: while you're not limited to re-creating the existing output formats (like 'genomic-region-dict'), implementing\nthem in your datatype may allow existing consumers of data providers (for example, a visualization that expects\n'genomic-region-dict' formatted data) to use your datatype 'right off the shelf'.</p>\n<p>The settings variable passed to the decorator (<code>GenomicRegionDataProvider.settings</code> in the example above)\nare a list of the options that will be parsed on a query string before being sent to the dataprovider. In other words,\nwhen a provider is called from the API many of its options can be passed over the url in the query string:</p>\n<pre><code class=\"language-bash\">curl 'http://localhost:8080/api/datasets/86cf1d3beeec9f1c?data_type=raw_data&#x26;provider=column&#x26;limit=2&#x26;offset=1'\n</code></pre>\n<p>The settings variable of the column data provider is a class level dictionary containing keys matching options to be\nparsed and values that are the final form to parse those options into (from the query string):</p>\n<pre><code class=\"language-python\">class ColumnarDataProvider( line.RegexLineDataProvider ):\n    # ...\n    settings = {\n        'indeces'       : 'list:int',\n        'column_count'  : 'int',\n        'column_types'  : 'list:str',\n        'parse_columns' : 'bool',\n        'deliminator'   : 'str'\n    }\n</code></pre>\n<p>This ensures that indeces within an API call's query string (<code>indeces=1,2,3</code>) will be correctly sent to the column\ndata provider as [ 1, 2, 3 ], <code>column_count</code> as a boolean, etc.</p>\n<p>It's generally enough to use the settings of an existing provider, but you may want to make your own options available\nin addition to existing settings.</p>\n<p>For more examples than are on this page, see <a href=\"/data-providers/cookbook/\">DataProviders/Cookbook</a>.</p>\n<pre><code class=\"language-wiki\">----\n## Troubleshooting\n\n#### Errors\n</code></pre>\n</div>\n"}},"context":{}}