{"hash":"ef8aba8bb8a02457efb168ecda8caf9311205534","data":{"article":{"id":"eda2983d373f29a19e46d83873cf219e","title":"Problem with logout when using LDAP for authentication with remoteUser enabled","tease":"Make changes to 4 Galaxy configuration files ","category":"blog","date":"2014-01-27","days":null,"contact":"","contact_url":"","authors":"Tim Booth","location":"","location_url":"","source_blog":"","source_blog_url":"","skip_title_render":null,"redirect":"","links":[],"image":"","images":{},"external_url":"","content":"<div class=\"toc-wrapper col-md-3\">\n<ul>\n<li>\n<p><a href=\"#tim-booths-response\">Tim Booth's Response</a></p>\n<ul>\n<li><a href=\"#usrsharegalaxy-serverlogouthtaccess\">/usr/share/galaxy-server/logout/.htaccess</a></li>\n<li><a href=\"#usrsharegalaxy-serverlogouthtpasswd\">/usr/share/galaxy-server/logout/.htpasswd</a></li>\n<li><a href=\"#usrsharegalaxy-serverproxyhtaccess\">/usr/share/galaxy-server/proxy/.htaccess</a></li>\n<li><a href=\"#etcgalaxy-serveruniverse_wsgid31_apache-proxyini\">/etc/galaxy-server/universe_wsgi.d/31_apache-proxy.ini</a></li>\n<li><a href=\"#etcapache2confdgalaxy\">/etc/apache2/conf.d/galaxy</a></li>\n<li><a href=\"#links\">Links</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<div class=\"body-wrapper col-md-9\">\n<p>Alper Kucukural posted this <a href=\"https://lists.galaxyproject.org/archives/list/galaxy-dev@lists.galaxyproject.org/thread/DEYFKN3SZ2JJ5J3RUS62RS7NOZFGTKAN/#DEYFKN3SZ2JJ5J3RUS62RS7NOZFGTKAN\" target=\"_blank\" rel=\"noopener noreferrer\">Galaxy-Dev thread</a> about logout problems when using LDAP for authentication with remoteUser enabled.  This page is based on Tim Booth's response.   Furthermore, Helena Rasche also brought these pages up to date to reflect this discussion:</p>\n<ul>\n<li><a href=\"/admin/config/apache-proxy/#proxying-multiple-galaxy-worker-threads\">Proxying Galaxy with Apache</a></li>\n<li><a href=\"/admin/config/external-user-auth/\">External User Authentication</a></li>\n</ul>\n<p>Many, many thanks to Tim and Eric for this work.</p>\n<h1 id=\"tim-booths-response\"><a href=\"#tim-booths-response\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Tim Booth's Response</h1>\n<p>I'm currently using one of those hacks, and it seems to work nicely for\nthe user (Chrome + FF at least) but it does need some messy setting up\nin Apache and some cunning redirects in place.  I've pasted the relevant\nfile fragments below.  It's somewhat confounded with my stuff to enable\nSFTP uploads but hopefully you get the idea and the original explanation\non Stackoverflow is pretty good.  The remote_user_logout_href is\nsomething I got to by trial and error.</p>\n<h2 id=\"usrsharegalaxy-serverlogouthtaccess\"><a href=\"#usrsharegalaxy-serverlogouthtaccess\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>/usr/share/galaxy-server/logout/.htaccess</h2>\n<pre><code>% cat /usr/share/galaxy-server/logout/.htaccess\n# HaCk based on http://stackoverflow.com/questions/4163122/http-basic-authentication-log-out\n# Authname must match the one in ../proxy/.htaccess\n\nAuthType Basic\nAuthName Galaxy_Server\n\nAuthUserFile /usr/share/galaxy-server/logout/.htpasswd\nRequire user logout\n</code></pre>\n<h2 id=\"usrsharegalaxy-serverlogouthtpasswd\"><a href=\"#usrsharegalaxy-serverlogouthtpasswd\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>/usr/share/galaxy-server/logout/.htpasswd</h2>\n<pre><code>% cat /usr/share/galaxy-server/logout/.htpasswd\n#Password is logout.  This in not a secret.\nlogout:$apr1$0eB1iURY$kwqa0c8tXksbjPQLYqr6s.\n</code></pre>\n<h2 id=\"usrsharegalaxy-serverproxyhtaccess\"><a href=\"#usrsharegalaxy-serverproxyhtaccess\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>/usr/share/galaxy-server/proxy/.htaccess</h2>\n<pre><code>% cat /usr/share/galaxy-server/proxy/.htaccess\n# Security settings for Galaxy proxied via Apache.  Note the actual\n# proxy config is under /etc/apache2/conf.d/galaxy.  If for some\n# reason you wanted Apache proxy with internal Galaxy authentication\n# then you could remove this file and Apache would no longer insist on\n# authentication.\nAuthBasicProvider external\nAuthExternal pwauth\nAuthType Basic\nAuthName Galaxy_Server\n\n#I'd like to do this, but it upsets Firefox. Use ErrorDocument instead.\n# AuthName \"Galaxy Server: \\\n# Log in with regular username and password. \\\n# Users need to be in the galaxy system group.\"\n\nErrorDocument 401 \"&#x3C;html>\\\n&#x3C;title>401 Authorization Required&#x3C;/title>\\\n&#x3C;h1>Log-in to Galaxy failed&#x3C;/h1>\\\n&#x3C;p>You should have been prompted to log into the Galaxy server. \\\nYou need to give your regular system username and password. \\\nPlease reload this page to try again.&#x3C;/p>\\\n&#x3C;p>If this fails, check that you are a member of the galaxy system\ngroup, by \\\nrunning &#x3C;code>groups&#x3C;/code> on the command line.&#x3C;/p>\\\n&#x3C;p>To add a user, eg. user1, to this group, you may use the\ncommand:&#x3C;/p>\\\n&#x3C;ul>&#x3C;li>&#x3C;code>sudo usermod -aG galaxy user1&#x3C;/code>&#x3C;/ul>&#x3C;/li>\\\n&#x3C;/html>\"\n\n# You may want to comment these 2 lines out or to\n# change the group required, but users still need to\n# be in the galaxy group for SFTP uploads to work properly.\nAuthzUnixgroup on\nRequire group galaxy\n\n# This is needed to tell Galaxy about the remote\n# user.\nRequestHeader set REMOTE_USER %{RU}e env=RU\nRequestHeader unset Authorization env=RU\n</code></pre>\n<h2 id=\"etcgalaxy-serveruniverse_wsgid31_apache-proxyini\"><a href=\"#etcgalaxy-serveruniverse_wsgid31_apache-proxyini\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>/etc/galaxy-server/universe_wsgi.d/31_apache-proxy.ini</h2>\n<pre><code>% cat /etc/galaxy-server/universe_wsgi.d/31_apache-proxy.ini                        \n# Settings added by debian-galaxy-apache-proxy to switch Galaxy over to\n# authenticating by real user accounts and also permitting uploads.\n\n[app:main]\n\n# Other scripts assume that maildomain is localhsot, so you can't just\n# change the setting below and expect everythig to work.\nuse_remote_user = True\nremote_user_maildomain = localhost\n\n# Users may copy files here directly or upload via SFTP/SCP\nftp_upload_dir = /var/lib/galaxy-server/transfer\nftp_upload_site = *** Transfer files via SCP or SFTP to /var/lib/galaxy-server/transfer/... ***\n\n# There is no neat way to log out a user with Basic Auth, but here is a non-neat way.\n# Not yet tested on IE.\nremote_user_logout_href = javascript:var r=new XMLHttpRequest();r.onreadystatechange=function(){if(r.readyState==4)window.location.replace('logout.html')};r.open('get','logout.html',true,'logout','logout');r.send();\n</code></pre>\n<h2 id=\"etcapache2confdgalaxy\"><a href=\"#etcapache2confdgalaxy\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>/etc/apache2/conf.d/galaxy</h2>\n<pre><code>% cat /etc/apache2/conf.d/galaxy\n#  Note: These rules are essentially equivalent to the ones listed in the Wiki page\n#  but for those to work on BL they would need to be placed within the &#x3C;VirtualHost>\n#  tags in /etc/apache2/sites-enabled/default whereas this variant can be put\n#  into conf.d without editing any existing files.  Order of rules is very important.\n\n#  The proxy directory holds the .htaccess file which activates pwauth authentication.\n#  If I put the .htaccess file in the top-level directory then pwauth ends up being run\n#  for every static file and it is slow, slow, slow.\n\nAlias /galaxy /usr/share/galaxy-server\n&#x3C;Directory /usr/share/galaxy-server>\nOptions -Indexes\nRewriteEngine on\nRewriteBase /galaxy\nRewriteRule ^(logout\\..*) logout/$1 [L]\nRewriteRule ^logout/ - [L]\nRewriteRule ^static/style/(.*) static/june_2007_style/blue/$1 [L]\nRewriteRule ^static/scripts/packed/ - [L]\nRewriteRule ^static/scripts/(.*) static/scripts/packed/$1 [L]\nRewriteRule ^(static|test-data)/ - [L]\nRewriteRule ^(favicon.ico|robots.txt) static/$1 [L]\nRewriteRule (.*) proxy/$1\n&#x3C;/Directory>\n\n&#x3C;Directory /usr/share/galaxy-server/logout>\nOptions -Indexes\nAllowOverride AuthConfig FileInfo\n&#x3C;/Directory>\n\n&#x3C;Directory /usr/share/galaxy-server/proxy>\nOptions -Indexes\nAllowOverride AuthConfig FileInfo\nRewriteEngine on\nRewriteBase /galaxy/proxy\nRewriteRule (.*) http://localhost:8080/$1 [P,E=RU:%{REMOTE_USER}]\n&#x3C;/Directory>\n</code></pre>\n<h2 id=\"links\"><a href=\"#links\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Links</h2>\n<ul>\n<li><a href=\"https://lists.galaxyproject.org/archives/list/galaxy-dev@lists.galaxyproject.org/thread/DEYFKN3SZ2JJ5J3RUS62RS7NOZFGTKAN/#DEYFKN3SZ2JJ5J3RUS62RS7NOZFGTKAN\" target=\"_blank\" rel=\"noopener noreferrer\">Original thread on Galaxy-Dev</a></li>\n<li><a href=\"/admin/config/apache-proxy/#proxying-multiple-galaxy-worker-threads\">Proxying Galaxy with Apache</a></li>\n<li><a href=\"/admin/config/external-user-auth/\">External User Authentication</a></li>\n</ul>\n</div>\n"}},"context":{}}