{"hash":"6a87f55bb3e5a997903b2c87cff72c00cc3c86c4","data":{"article":{"id":"471a64bed37983710e1bacdf755a901b","title":"Using volume storage","tease":"","image":"","images":{},"category":null,"contact":"","date":null,"content":"<p><a href=\"http://jetstream-cloud.org/general-vms.php\" target=\"_blank\" rel=\"noopener noreferrer\">Jetstream instances</a> come with a\npredefined amount of local (i.e., ephemeral or transient) storage. It is\npossible to use persistent, volume-based storage that can also vary in size,\ndepending on your allocation.</p>\n<p>Note that using volume-based storage requires some command line work\nand should be considered beta functionality. <strong>Also note that if you delete\n(ie, terminate) your instance, even though your volume will continue to exist,\nit will be useless because the database that links Galaxy to all the datasets\nresides on the instance storage.</strong> However, you may <em>stop</em> an instance and\nthen follow the steps below to make Galaxy use the same volume again.</p>\n<h2 id=\"configuring-galaxy-to-use-a-volume\"><a href=\"#configuring-galaxy-to-use-a-volume\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Configuring Galaxy to use a volume</h2>\n<p>Follow these steps to attach an external volume to your instance and make Galaxy\nuse it:</p>\n<ul>\n<li>\n<p>Through the Atmosphere portal, create a volume of desired size and attach it\nto your instance. Following the screenshots below to have a visual reference.\nWhen creating the volume, make sure it is created in the same provider as\nthe one your Galaxy instance is running in (in the screenshots below, this\nis <em>Jetstream - TACC</em>).</p>\n  <div class='center'>\n    <a href=\"/volume-create-btn.png\"><img src=\"./volume-create-btn.png\" alt=\"\" width=200 /></a>\n    <a href=\"/volume-create.png\"><img src=\"./volume-create.png\" alt=\"\" width=200 /></a>\n    <a href=\"/volume-edit.png\"><img src=\"./volume-edit.png\" alt=\"\" width=200 /></a>\n    <a href=\"/volume-attach-btn.png\"><img src=\"./volume-attach-btn.png\" alt=\"\" width=200 /></a>\n    <a href=\"/volume-attach.png\"><img src=\"./volume-attach.png\" alt=\"\" width=200 /></a>\n    <a href=\"/volume-attached.png\"><img src=\"./volume-attached.png\" alt=\"\" width=200 /></a>\n  </div>\n</li>\n<li>\n<p><a href=\"/cloud/jetstream/ssh/\">Access your instance via ssh</a> and create\na directory for the Galaxy files. The volume you attached to your instance\nwill be most likely be available under <code>/vol_c</code> so create a directory under\nÂ that one. Change the ownership of the directory to the <code>galaxy</code> system user.</p>\n<pre><code>sudo mkdir /vol_c/gxy_data\nsudo chown galaxy:galaxy /vol_c/gxy_data\n</code></pre>\n<p>It may be possible for the volume to have gotten mounted to the instance\nunder a directoy different than <code>/vol_c</code>. You will know this if the <code>mkdir</code>\ncommand above fails. In that case, discover which where the volume got\nmounted by running the <code>df</code> command:</p>\n<pre><code>$ df\nFilesystem     1K-blocks     Used Available Use% Mounted on\nudev            61883716       12  61883704   1% /dev\ntmpfs           12377780      452  12377328   1% /run\n/dev/sda1       61893628 19750448  39595940  34% /\nnone                   4        0         4   0% /sys/fs/cgroup\nnone                5120        0      5120   0% /run/lock\nnone            61888888        0  61888888   0% /run/shm\nnone              102400        0    102400   0% /run/user\n/dev/sdb       980385892    95308 930466840   1% /vol1\n</code></pre>\n<p>In this case, the volume is available under <code>/vol1</code>. If that is the case,\njust replace all occurances of <code>vol_c</code> in the commands with the available\npath.</p>\n</li>\n<li>\n<p>Edit the following entries in the main Galaxy configuration file\n<code>/opt/galaxy/galaxy-app/config/galaxy.ini</code> to point to the directory you\ncreated.</p>\n<pre><code>$ nano /opt/galaxy/galaxy-app/config/galaxy.ini\n# (Edit the following lines in the file)\nnew_file_path = /vol_c/gxy_data/tmp\njob_working_directory = /vol_c/gxy_data/jobs\nfile_path = /vol_c/gxy_data/datasets\nobject_store_cache_path = /vol_c/gxy_data/object_store_cache\n</code></pre>\n</li>\n<li>Restart Galaxy with the following command\n<code>sudo supervisorctl restart galaxy:web0</code></li>\n</ul>\n<p>Run a couple of jobs through the Galaxy web interface now and see if the files\nare being written on the new volume. You should see output similar to this:</p>\n<pre><code>$ ls -l /vol_c/gxy_data/datasets/000/\ntotal 21588\n-rw-r--r-- 1 galaxy users  1206112 Apr 10 07:39 dataset_1.dat\n-rw-r--r-- 1 galaxy users 20896315 Apr 10 07:40 dataset_2.dat\n</code></pre>\n<p>If so, you are all set.</p>\n<h2 id=\"stopping-your-instance\"><a href=\"#stopping-your-instance\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Stopping your instance</h2>\n<p>You may stop an instance and start it back up at a later time while\npreserving the data on the volume. Again, if you <em>delete</em> the instance, all\nthe data will be lost.</p>\n<p>To stop an instance, follow these steps:</p>\n<ul>\n<li>Stop the Galaxy application process from the command line with\n<code>sudo supervisorctl stop galaxy:web0</code></li>\n<li>Via the Atmosphere portal, detach the volume from your instance and then stop\nthe instance.</li>\n</ul>\n<p>Your instance and the volume will remain available under your account available\nfor use at a later time.</p>\n<h2 id=\"restarting-your-instance\"><a href=\"#restarting-your-instance\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>(Re)Starting your instance</h2>\n<p>To (re)start your instance and attach it to the previously used volume, do the\nfollowing steps:</p>\n<ul>\n<li>Start your previously stopped instance via the Atmosphere portal and attach\nthe volume to it.</li>\n<li>Access your instance via ssh again. If you are using the terminal, note that\nthe IP address of the instance has likely changed.</li>\n<li>\n<p>Run the following commands to set ownership of the Galaxy directory to the\n<code>galaxy</code> system user (Atmosphere resets those when you attach a volume) and\nthen start Galaxy:</p>\n<pre><code>sudo chown -R galaxy:galaxy /vol_c/gxy_data\nsudo supervisorctl start galaxy:web0\n</code></pre>\n</li>\n</ul>\n<p>In a few moments Galaxy should be available on your instance with the same data\nas where you left it.</p>\n"}},"context":{}}