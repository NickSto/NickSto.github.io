{"hash":"fe50d2d58b71effa03c01b08cdaab48b91e9d3d3","data":{"article":{"id":"5d530e300ca324cfaa3479aedee0ee80","title":"Tutorial: Galaxy Installation and Administration","tease":"","category":"","date":null,"days":null,"contact":"","contact_url":"","authors":"","location":"","location_url":"","source_blog":"","source_blog_url":"","skip_title_render":null,"links":[],"image":"","images":{},"inserts":[{"name":"/events/gcc2014/header","content":"<div class=\"text-center trim-p\">\n<p><a href=\"/events/gcc2014/\"><img src=\"/images/logos/GCC2014LogoWide600.png\" alt=\"2014 Galaxy Community Conference (GCC2014), Baltimore Maryland, United States, June 30 - July 2 2014\"></a></p>\n<p><br /><br /></p>\n<p><span style=\"font-size: larger;\"> <a href=\"/events/gcc2014/abstracts/\">Slides, posters, and videos are now available</a>;  <em>and</em> <a href=\"https://gccbosc2018.sched.com/\" target=\"_blank\" rel=\"noopener noreferrer\">GCC2018</a> is coming! </span></p>\n</div>\n"},{"name":"/events/gcc2014/linkbox","content":"<div class=\"alert alert-info float-right text-center\">\n<p><a href=\"/events/gcc2014/\"><strong>GCC2014</strong></a><br>\n<a href=\"/events/gcc2014/training-day\">Training</a><br>\n<a href=\"/events/gcc2014/program\">Program</a><br>\n<a href=\"/events/gcc2014/abstracts\">Abstracts</a><br>\n<a href=\"/events/gcc2014/bofs\">BoFs</a><br>\n<a href=\"/events/gcc2014/lightning\">Lightning</a><br>\n<a href=\"/events/gcc2014/logistics\">Logistics</a><br>\n<a href=\"/events/gcc2014/sponsor-exhibit\">Sponsors</a><br>\n<a href=\"/events/gcc2014/hackathon\">Hackathon</a><br>\n<a href=\"/events/gcc2014/promotion\">Promotion</a><br>\n<a href=\"/events/gcc2014/register\">Registration</a><br>\n<a href=\"/events/gcc2014/key-dates\">Key Dates</a><br>\n<a href=\"/events/gcc2014/organizers\">Organizers</a></p>\n</div>\n"}],"external_url":"","content":"\ntable-of-contents\n=================\n\nend-table-of-contents\n=====================\n\n<slot name=\"/events/gcc2014/header\" />\n\n<br /><br />\n\n<slot name=\"/events/gcc2014/linkbox\" />\n\n<div class='right'> <a href=\"/events/gcc2014/training-day/\"><img src=\"/images/logos/GCC2014TrainingDayLogoSquare.png\" alt=\"GCC2014 Training Day\" width=\"100\" /></a></div>\n\n[Nate Coraor](/people/nate/) and [John Chilton](/people/john-chilton/)\n\n<br />\n\n![](https://dev.twitter.com/sites/default/files/images_documentation/bird_blue\\_16.png) #usegalaxy\n\nThis this follow-along page assumes you have already installed and started a [Training Day VM](https://wiki.galaxyproject.org/Events/GCC2014/TrainingDay/VMs) - please do this before arriving.\n\n**This tool assumes you are using Firefox bundled with the VM.** Galaxy is compatible with all modern versions of Firefox, Chrome, Safari, and Internet Explorer. However, for the purposes of this tutorial it will help us when assisting people encountering problems if they are only using Firefox.\n\nYou will most likely want to copy and paste between this wiki page and the VM. To allow this, after launching the VM, click the **Devices** menu, then **Shared Clipboard** â†’ **Bidirectional**. The key combination **Shift+Ctrl+V** in the VM will paste the contents of the clipboard.\n\nIf your host system has enough memory, we suggest increasing the memory allocated to the VM to 2 GB.\n\nSetting up a Local Galaxy Tutorial (Part I)\n===========================================\n\nClone (download) Galaxy\n-----------------------\n\nThe Galaxy distribution is found at <https://bitbucket.org/galaxy/galaxy-dist/>, but for the purposes of this tutorial, we'll use a local copy already on the VM to save time.\n\n```console\ngalaxy@gcc2014:~$ hg clone /home/galaxy/galaxy-central galaxy-dist\nrequesting all changes\nadding changesets\nadding manifests\nadding file changes\nadded 8 changesets with 3443 changes to 3443 files\nupdating to branch default\n3443 files updated, 0 files merged, 0 files removed, 0 files unresolved\ngalaxy@gcc2014:~$\n```\n\n(One can launch a terminal in the VM by clicking the little mouse icon in the upper left corner and then clicking the \"Terminal Emulator\" icon in the pop-up menu.)\n\n### References\n\n* [getgalaxy.org](http://getgalaxy.org)\n* [Galaxy Wiki/documentation](https://wiki.galaxyproject.org)\n\nUpdate to the stable branch\n---------------------------\n\n```console\ngalaxy@gcc2014:~$ cd galaxy-dist\ngalaxy@gcc2014:~/galaxy-dist$ hg update stable\n264 files updated, 0 files merged, 144 files removed, 0 files unresolved\ngalaxy@gcc2014:~/galaxy-dist$\n```\n\nStart Galaxy\n------------\n\n```\ngalaxy@gcc2014:~/galaxy-dist$ cp -r ../galaxy-central/eggs eggs  # cache dependencies to speed up deploy (optional)\ngalaxy@gcc2014:~/galaxy-dist$ sh run.sh\nInitializing datatypes_conf.xml from datatypes_conf.xml.sample\n  ...\nSome eggs are out of date, attempting to fetch...\nFetched http://eggs.galaxyproject.org/amqp/amqp-1.4.3-py2.7.egg\n  ...\nFetch successful.\npython path is: /home/ubuntu/galaxy-dist/eggs/mercurial-2...\n  ...\nStarting server in PID 3091.\nserving on http://127.0.0.1:8080\n```\n\nInstalling tools from the Tool Shed\n-----------------------------------\n\n### Topics for this section\n\n* What is a Galaxy tool?\n  * Basic: An XML description of the tool's interface, allowing Galaxy to render a UI (tool form), as well as the command line to execute.\n  * Complex: XML + wrapper scripts and interfaces to external dependencies\n* Exploring preinstalled tools and filesystem layout\n  * `galaxy-dist/tool_conf.xml`\n  * `galaxy-dist/tools/`\n  * Example simple tool: `galaxy-dist/tools/filters/sorter.xml` (tool xml), `galaxy-dist/tools/filters/sorter.py` (tool code)\n  * Example tool with unmet dependencies: `galaxy-dist/tools/sr_mapping/mosaik.xml`\n* The Tool Shed\n  * Installing tools from the Tool Shed\n  * Exploring the filesystem layout of tools installed from the Tool Shed\n\n### Galaxy configuration for Tool Shed installs\n\nStop Galaxy by hitting `CTRL-c`:\n\n```console\nserving on http://127.0.0.1:8080\n^Cgalaxy.jobs.handler INFO 2014-04-23 13:27:59,203 sending stop signal to worker thread\ngalaxy.jobs.handler INFO 2014-04-23 13:27:59,204 job handler queue stopped\ngalaxy.jobs.runners INFO 2014-04-23 13:27:59,204 LWRRunner: Sending stop signal to monitor thread\ngalaxy.jobs.runners INFO 2014-04-23 13:27:59,204 LWRRunner: Sending stop signal to 3 worker threads\ngalaxy.jobs.runners INFO 2014-04-23 13:27:59,204 LocalRunner: Sending stop signal to 5 worker threads\ngalaxy.jobs.handler INFO 2014-04-23 13:27:59,205 sending stop signal to worker thread\ngalaxy.jobs.handler INFO 2014-04-23 13:27:59,205 job handler stop queue stopped\ngalaxy@gcc2014:~/galaxy-dist$\n```\n\nThere may be some additional interruption exceptions reported - these are not important.\n\nEdit the primary Galaxy configuration file, `universe_wsgi.ini`. If you are not familiar with `vi`, consider using `nano` instead.\n\n```console\ngalaxy@gcc2014:~/galaxy-dist$ vi universe_wsgi.ini\n```\n\nWe need to set two options. The file is large and it's easiest to search for these (`/<pattern>` in vi, `CTRL-w` `<pattern>` in nano):\n\n```ini\n[app:main]\nadmin_users = nate@bx.psu.edu\ntool_dependency_dir = /home/galaxy/tool_deps\n```\n\nThen save and quit (`CTRL-x` `y` `ENTER` in nano). Start Galaxy again:\n\n```console\ngalaxy@gcc2014:~/galaxy-dist$ sh run.sh\n...\nStarting server in PID 3298.\nserving on 127.0.0.1:8080 view at http://127.0.0.1:8080\n```\n\n### Install a tool from the Tool Shed\n\n* Register an account that matches the address you set in `admin_users`\n* Follow the [tutorial on installing tools from the Tool Shed](/admin/tools/add-tool-from-toolshed-tutorial/). In brief:\n  * Click **Admin** from the masthead\n  * Click **Search and browse tool sheds** from the left panel\n  * Click the popup icon for **Galaxy main tool shed** and select **Search for valid tools**\n  * Search for **Tool name**s that contain the name `bwa`\n  * Click the popup icon for **bwa_wrappers** owned by **devteam** and select **Install to Galaxy**\n  * Select the **NGS: Mapping** section and click **Install to Galaxy**\n* Tools (XML, wrapper scripts) are installed in `/home/galaxy/shed_tools`\n* Tool dependencies (binaries) are installed in `/home/galaxy/tool_deps`\n\n### References\n\n* [Tools hub page](/tools/)\n* [Tutorial on adding custom tools](/admin/tools/add-tool-tutorial/)\n* [Tutorial on installing tools from the Tool Shed](/admin/tools/add-tool-from-toolshed-tutorial/)\n* [Current tools/ directory](https://bitbucket.org/galaxy/galaxy-central/src/3b42725359224832317a066d95dff596f93ab33f/tools?at=stable)\n* [Tool Shed hub page](/toolshed/)\n* [Tool Shed tour](/toolshed/tour/)\n* [Galaxy Main Tool Shed](http://toolshed.g2.bx.psu.edu/)\n\nManaging local data\n-------------------\n\n### Topics for this section\n\n* What is local data?\n* Manual data inclusion\n  * Building indexes on the command line\n  * `.loc` files\n  * `tool_data_table_conf.xml`\n  * Example of the above with bwa and S. cerevisiae (sacCer2) [transcript](/events/gcc2014/training-day/admin-walkthrough/#adding-local-data-by-hand)\n* Galaxy Data Managers\n\n### Adding local data with a Galaxy Data Manager\n\nInstall data managers for fetching the reference genome and building BWA indexes:\n\n* Click **Admin** from the masthead\n* Click **Search and browse tool sheds** from the left panel\n* Click the popup icon for **Galaxy main tool shed** and select **Search for valid tools**\n* Search for **Tool id**s that contain the name `manager`\n* Check **data_manager_fetch_genome_all_fasta** and **data_manager_bwa_index_builder**, then click **Install to Galaxy** (at the bottom of the page)\n* Click **Install**\n\nFetch reference genome (fasta):\n\n* Click **Manage local data (beta)** from the left panel\n* Click **Reference Genome - fetching**\n* In the **DBKEY to assign to data:** field, type `sacCer2`\n* In the **UCSC's DBKEY for source FASTA:** field, type `sacCer2`\n* Click **Execute**\n\nBuild BWA indexes:\n\n* Click **Manage local data (beta)** from the left panel\n* Click **BWA index - builder**\n* Click **Execute**\n\nUpon completion:\n\n* `galaxy-dist/tool-data/sacCer2/seq/sacCer2.fa` has been created from chromosome fastas fetched from UCSC\n* `galaxy-dist/tool-data/sacCer2/bwa_index/sacCer2.fa.*` indexes have been generated with `bwa index`\n* `galaxy-dist/tool-data/toolshed.g2.bx.psu.edu/repos/devteam/data_manager_fetch_genome_all_fasta/2ebc856bce29/all_fasta.loc` contains a reference to the newly created `sacCer2.fa`\n* `galaxy-dist/tool-data/toolshed.g2.bx.psu.edu/repos/devteam/data_manager_bwa_index_builder/367878cb3698/bwa_index.loc` contains a reference to the newly built bwa indexes\n* `galaxy-dist/shed_tool_data_table_conf.xml` includes entries for the `all_fasta` and `bwa_indexes` data tables\n\n### References\n\n* [(Manual) index building](/admin/data-preparation/)\n* [(Manual) data integration](/admin/data-integration/)\n* [Automated data management with Data Managers](/admin/tools/data-managers/)\n\nSetting up a Local Galaxy Tutorial (Part II)\n============================================\n\nDocumentation for the features used in this section can be found at [usegalaxy.org/production](https://usegalaxy.org/production) (forwards to [Admin/Config/Performance/ProductionServer](/admin/config/performance/production-server/))\n\nInstall and configure PostgreSQL\n--------------------------------\n\n```hightlight console\ngalaxy@gcc2014:~/galaxy-dist$ sudo apt-get install postgresql\n[sudo] password for galaxy:\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\npostgresql is already the newest version.\n...\ngalaxy@gcc2014:~/galaxy-dist$ sudo -u postgres createuser gxprod\ngalaxy@gcc2014:~/galaxy-dist$ sudo -u postgres createdb -O gxprod gxprod\n```\n\nCreate a new user for Galaxy\n----------------------------\n\n```console\ngalaxy@gcc2014:~/galaxy-dist$ sudo useradd -m -s /bin/bash gxprod\ngalaxy@gcc2014:~/galaxy-dist$\n```\n\nCreate a Python virtual environment\n-----------------------------------\n\n```console\ngalaxy@gcc2014:~/galaxy-dist$ sudo apt-get install python-virtualenv\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nThe following extra packages will be installed:\n  ...\nDo you want to continue? [Y/n]\n  ...\nGet:1 http://us.archive.ubuntu.com/ubuntu/ trusty/main libasan0 amd64 4.8.2-19ubuntu1 [63.0 kB]\n  ...\nProcessing triggers for libc-bin (2.19-0ubuntu6) ...\ngalaxy@gcc2014:~/galaxy-dist$ sudo -iu gxprod\ngxprod@gcc2014:~$ virtualenv venv\nNew python executable in venv/bin/python\nInstalling setuptools, pip...done.\ngxprod@gcc2014:~$ source ./venv/bin/activate\n(venv)gxprod@gcc2014:~$\n```\n\nClone (download) Galaxy\n-----------------------\n\n```console\ngxprod@gcc2014:~$ hg clone ~galaxy/galaxy-central galaxy-dist\nnot trusting file /home/galaxy/galaxy-central/.hg/hgrc from untrusted user galaxy, group galaxy\nrequesting all changes\nadding changesets\nadding manifests\nadding file changes\nadded 13944 changesets with 47333 changes to 8458 files\nupdating to branch default\n3658 files updated, 0 files merged, 0 files removed, 0 files unresolved\ngxprod@gcc2014:~$ cd galaxy-dist\ngxprod@gcc2014:~/galaxy-dist$ hg update stable\n264 files updated, 0 files merged, 144 files removed, 0 files unresolved\ngxprod@gcc2014:~/galaxy-dist$ cp -r ~galaxy/galaxy-central/eggs .\n0 files updated, 0 files merged, 0 files removed, 0 files unresolved\ngxprod@gcc2014:~/galaxy-dist$\n```\n\nConfigure Galaxy\n----------------\n\n```console\ngxprod@gcc2014:~/galaxy-dist$ cp universe_wsgi.ini.sample universe_wsgi.ini\ngxprod@gcc2014:~/galaxy-dist$ vi universe_wsgi.ini\n```\n\nAdd the following section for uWSGI's configuration and the job handler processes\n\n```ini\n[uwsgi]\nsocket = 127.0.0.1:4001\nstats = 127.0.0.1:9191\nprocesses = 2\nthreads = 4\nmaster = True\nlogto = /home/gxprod/uwsgi.log\npythonpath = lib\n\n[server:handler0]\nuse = egg:Paste#http\nport = 9010\nuse_threadpool = True\nthreadpool_workers = 10\n\n[server:handler1]\nuse = egg:Paste#http\nport = 9011\nuse_threadpool = True\nthreadpool_workers = 10\n```\n\nSet the following settings in the `[app:main]` section **at the bottom of the file**:\n\n```ini\ndatabase_connection = postgresql:///gxprod?host=/var/run/postgresql\ndatabase_engine_option_server_side_cursors = True\ntool_dependency_dir = /home/gxprod/tool_deps\nstatic_enabled = False\nnginx_x_accel_redirect_base = /_x_accel_redirect\nnginx_upload_store = /home/gxprod/uploads\nnginx_upload_path = /_upload\nlog_events = False\nlog_actions = False\ndebug = False\nuse_interactive = False\nid_secret = <random text>\nadmin_users = nate@bx.psu.edu\nlibrary_import_dir = /home/gxprod/library\nallow_library_path_paste = True\n```\n\nExplanations of these options:\n\n* `database_connection = postgresql:///gxprod?host=/var/run/postgresql` - Use a PostgreSQL database via a local UNIX domain socket (the socket is in `/var/run/postgresql`). [documentation](https://docs.galaxyproject.org/en/latest/admin/production.html#switching-to-postgresql-database-server)\n* `database_engine_option_server_side_cursors = True` - Keep large SQL query results on the PostgreSQL server, rather the transferring the entire result set to the Galaxy processes.\n* `tool_dependency_dir = /home/gxprod/tool_deps` - The directory that will house tool dependencies\n* `static_enabled = False` - Static content will be served by the proxy server\n* `nginx_x_accel_redirect_base = /_x_accel_redirect` - Delegate dataset downloads to nginx\n* `nginx_upload_store = /home/gxprod/uploads` - Delegate uploads to nginx, set temporary directory\n* `nginx_upload_path = /_upload` - Special path configured in nginx where uploads will be POSTed\n* `log_events = False` - Don't log events in the database (faster)\n* `log_actions = False` - Don't log actions in the database (faster)\n* `debug = False` - Disables debugging middleware that loads server responses in to memory (can crash the server when handling large files)\n* `use_interactive = False` - Disables live client browser debugging (insecure).\n* `id_secret = <random text>` - Ensures that the encoded IDs used by Galaxy (especially session IDs) are unique.  One simple way to generate a value for this is with a shell command like `$ date | md5sum`\n* `admin_users = nate@bx.psu.edu` - Make nate@example.org an administrator. Galaxy's Admin UI is only accessible if you define administrators here!\n* `library_import_dir = /home/gxprod/library` - Administrators can directly import datasets from this directory on the server to Data Libraries.  This includes an option that allows an effective \"symlink\" to the data, rather than copying it in to Galaxy's `file_path` directory. [documentation](/admin/data-libraries/#user-folder)\n* `allow_library_path_paste = True` - Administrators can import datasets from anywhere on the server's filesystem(s) by entering their paths in to a text box\n\nHonorable mentions for features we won't use today but that are common in big setups:\n\n* `ftp_upload_dir` and `ftp_upload_site` - Allow users to upload data to the server using FTP\n* `use_remote_user` and `remote_user_maildomain` - Use your institution's existing authentication system to log in to Galaxy. [Apache documentation](/admin/config/external-user-databases/) or [nginx documentation](https://galaxyproject.org/admin/config/nginx-external-user-auth/)\n* `allow_user_impersonation` - Users configured as administrators (with `admin_users`) can \"become\" other users to view Galaxy exactly as the impersonated user does. Useful for providing support.\n* `user_library_import_dir` - Non-administrators can directly import datasets from this directory on this server to Data Libraries from which they have been given write permission. [documentation](/data-libraries/#user-folder)\n* `object_store_config_file` - Configure Galaxy's \"object storage\" layer to store data in multiple filesystems, Amazon S3, iRODS, etc.\n* `error_email_to` (with `smtp_server`) - Allow users to send bug reports directly to you\n* `user_activation_on` and related options - Require new users to verify their email address\n* `allow_user_dataset_purge = True` - Allow users to forcibly remove their datasets from disk (note that the data is only actually removed if all versions of a shared dataset are purged by all users who are sharing the dataset). By default, Galaxy does not remove data, as this is done at a later time by the dataset cleanup scripts.\n* `enable_quotas = True` - Enable Galaxy's quota system. Quotas are configured by administrators in the Galaxy Admin UI\n\nCreate a job system configuration:\n\n```console\ngxprod@gcc2014:~/galaxy-dist$ vi job_conf.xml\n```\n\nIn the editor, paste:\n\n```xml\n<?xml version=\"1.0\"?>\n<job_conf>\n    <plugins workers=\"2\">\n        <plugin id=\"gridengine\" type=\"runner\" load=\"galaxy.jobs.runners.drmaa:DRMAAJobRunner\">\n            <param id=\"drmaa_library_path\">/usr/lib/gridengine-drmaa/lib/libdrmaa.so</param>\n        </plugin>\n        <!--\n        <plugin id=\"torque\" type=\"runner\" load=\"galaxy.jobs.runners.drmaa:DRMAAJobRunner\">\n            <param id=\"drmaa_library_path\">/usr/lib/pbs-drmaa/lib/libdrmaa.so</param>\n        </plugin>\n        <plugin id=\"slurm\" type=\"runner\" load=\"galaxy.jobs.runners.slurm:SlurmJobRunner\">\n            <param id=\"drmaa_library_path\">/usr/lib/slurm-drmaa/lib/libdrmaa.so</param>\n        </plugin>\n        -->\n    </plugins>\n    <handlers default=\"handlers\">\n        <handler id=\"handler0\" tags=\"handlers\"/>\n        <handler id=\"handler1\" tags=\"handlers\"/>\n    </handlers>\n    <destinations default=\"cluster\">\n        <destination id=\"cluster\" runner=\"gridengine\"/>\n        <!--\n        <destination id=\"cluster\" runner=\"torque\"/>\n        <destination id=\"cluster\" runner=\"slurm\"/>\n        -->\n    </destinations>\n    <limits>\n        <limit type=\"registered_user_concurrent_jobs\">2</limit>\n        <limit type=\"unregistered_user_concurrent_jobs\">1</limit>\n        <limit type=\"job_walltime\">24:00:00</limit>\n    </limits>\n</job_conf>\n```\n\nThis VM comes preconfigured with Torque, Grid Engine, and SLURM - Galaxy can submit jobs to any of these as well as LSF, Condor, etc... but the above configuration will just target the VM's default - Grid Engine.\n\nStart a Galaxy server to complete first run setup\n-------------------------------------------------\n\n```console\ngxprod@gcc2014:~/galaxy-dist$ sh run.sh\nInitializing datatypes_conf.xml from datatypes_conf.xml.sample\n  ...\nserving on http://127.0.0.1:8080\n^C\n  ...\ngxprod@gcc2014:~/galaxy-dist$ logout\ngalaxy@gcc2014:~$\n```\n\nInstall Ansible and nginx\n-------------------------\n\nWe would like to add a 3rd party module not available in Ubuntu's nginx packages (`nginx_upload_module`), which means recompiling nginx. However, we have already created an Ansible Play for compiling and packaging nginx. Ansible is an automation, configuration management and application deployment tool rapidly growing in popularity (it is similar to older projects such as Puppet and Chef).\n\n### Ansible\n\nCreate a new virtualenv and install Ansible:\n\n```console\ngalaxy@gcc2014:~$ virtualenv ansible\nNew python executable in ansible/bin/python\nInstalling setuptools, pip...done.\ngalaxy@gcc2014:~$ . ansible/bin/activate\n(ansible)galaxy@gcc2014:~$ pip install ansible\nDownloading/unpacking ansible\n  Downloading ansible-1.6.5.tar.gz (651kB): 651kB downloaded\n  Running setup.py (path:/home/galaxy/ansible/build/ansible/setup.py) egg_info for package ansible\n  ...\nSuccessfully installed ansible paramiko jinja2 PyYAML pycrypto ecdsa markupsafe\nCleaning up...\n(ansible)galaxy@gcc2014:~$\n```\n\nFetch the [nginx build playbook](https://bitbucket.org/natefoo/galaxy-ansible/src/e21adb25a3d585ab476e83f599028d73bf8d408c/build/nginx.yml):\n\n```console\n(ansible)galaxy@gcc2014:~$ wget https://bitbucket.org/natefoo/galaxy-ansible/raw/e21adb25a3d585ab476e83f599028d73bf8d408c/build/nginx.yml\n--2014-06-28 12:07:26--  https://bitbucket.org/natefoo/galaxy-ansible/raw/e21adb25a3d585ab476e83f599028d73bf8d408c/build/nginx.yml\nResolving bitbucket.org (bitbucket.org)... 131.103.20.168, 131.103.20.167\nConnecting to bitbucket.org (bitbucket.org)|131.103.20.168|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 6521 (6.4K) [text/plain]\nSaving to: â€˜nginx.ymlâ€™\n\n100%[=========================================>] 6,521       --.-K/s   in 0s\n\n2014-06-28 12:07:26 (974 MB/s) - â€˜nginx.ymlâ€™ saved [6521/6521]\n\n(ansible)galaxy@gcc2014:~$\n```\n\n### Build nginx\n\nRun the playbook to generate an nginx package:\n\n```console\n(ansible)galaxy@gcc2014:~$ ansible-playbook -i localhost, nginx.yml --ask-sudo-pass --extra-vars work_dir=/home/galaxy/nginx-build\nsudo password:\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\n  ...\n\nTASK: [Create deb] ************************************************************\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=12   changed=3    unreachable=0    failed=0\n\n(ansible)galaxy@gcc2014:~$ deactivate\ngalaxy@gcc2014:~$\n```\n\n### Install nginx\n\nUninstall conflicting nginx packages:\n\n```console\ngalaxy@gcc2014:~$ sudo apt-get remove nginx nginx-core nginx-common\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nThe following packages were automatically installed and are no longer required:\n  libcurses-perl libslurmdb-perl libslurmdb26\nUse 'apt-get autoremove' to remove them.\nThe following packages will be REMOVED:\n  nginx nginx-common nginx-core\n0 upgraded, 0 newly installed, 3 to remove and 12 not upgraded.\nAfter this operation, 1,295 kB disk space will be freed.\nDo you want to continue? [Y/n]\n(Reading database ... 244985 files and directories currently installed.)\nRemoving nginx (1.4.6-1ubuntu3) ...\nRemoving nginx-core (1.4.6-1ubuntu3) ...\nRemoving nginx-common (1.4.6-1ubuntu3) ...\nProcessing triggers for man-db (2.6.7.1-1) ...\ngalaxy@gcc2014:~$\n```\n\nInstall the new nginx package:\n\n```console\ngalaxy@gcc2014:~$ sudo dpkg -i /home/galaxy/nginx-build/nginx-galaxy_1.4.7-gxydev+trusty_amd64.deb\nSelecting previously unselected package nginx-galaxy.\n(Reading database ... 244964 files and directories currently installed.)\nPreparing to unpack .../nginx-galaxy_1.4.7-gxydev+trusty_amd64.deb ...\nUnpacking nginx-galaxy (1.4.7-gxydev+trusty) ...\nSetting up nginx-galaxy (1.4.7-gxydev+trusty) ...\ngalaxy@gcc2014:~$ sudo mkdir /var/opt/nginx\ngalaxy@gcc2014:~$\n```\n\nInstall uWSGI and supervisord\n-----------------------------\n\n```console\ngalaxy@gcc2014:~/galaxy-dist$ sudo apt-get install uwsgi uwsgi-plugin-python supervisor\n  ...\nAfter this operation, 4,497 kB of additional disk space will be used.\nDo you want to continue? [Y/n]\n  ...\ngalaxy@gcc2014:~/galaxy-dist$ sudo update-rc.d -f uwsgi remove\n Removing any system startup links for /etc/init.d/uwsgi ...\n   /etc/rc0.d/K20uwsgi\n   /etc/rc1.d/K20uwsgi\n   /etc/rc2.d/S20uwsgi\n   /etc/rc3.d/S20uwsgi\n   /etc/rc4.d/S20uwsgi\n   /etc/rc5.d/S20uwsgi\n   /etc/rc6.d/K20uwsgi\ngalaxy@gcc2014:~/galaxy-dist$\n```\n\nConfigure nginx\n---------------\n\n```console\ngalaxy@gcc2014:/opt/nginx/conf$ sudo vi /opt/nginx/conf/nginx.conf\n```\n\nReplace the entire contents of the file with:\n\n```nginx\nuser  gxprod;\nworker_processes  1;\ndaemon off;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n\n    sendfile        on;\n\n    keepalive_timeout  65;\n\n    gzip  on;\n    gzip_vary on;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_buffers 16 8k;\n    gzip_http_version 1.1;\n    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;\n\n    client_max_body_size 50g;\n    uwsgi_read_timeout 300;\n\n    server {\n        listen 80 default_server;\n        server_name  localhost;\n\n        # pass to uWSGI by default\n        location / {\n            uwsgi_pass 127.0.0.1:4001;\n            include uwsgi_params;\n        }\n\n        # serve static content\n        location /static {\n            alias /home/gxprod/galaxy-dist/static;\n            gzip on;\n            gzip_types text/plain text/xml text/javascript text/css application/x-javascript;\n            expires 24h;\n        }\n        location /static/style {\n            alias /home/gxprod/galaxy-dist/static/style/blue;\n            gzip on;\n            gzip_types text/plain text/xml text/javascript text/css application/x-javascript;\n            expires 24h;\n        }\n        location /static/scripts {\n            alias /home/gxprod/galaxy-dist/static/scripts/packed;\n            gzip on;\n            gzip_types text/plain text/javascript application/x-javascript;\n            expires 24h;\n        }\n        location ~ ^/plugins/visualizations/(?<vis_name>.+?)/static/(?<static_file>.*?)$ {\n            alias /home/gxprod/galaxy-dist/config/plugins/visualizations/$vis_name/static/$static_file;\n        }\n\n        # delegated downloads\n        location /_x_accel_redirect {\n            internal;\n            alias /;\n        }\n\n        # delegated uploads\n        location /_upload {\n            upload_store /home/gxprod/uploads;\n            upload_store_access user:rw;\n            upload_pass_form_field \"\";\n            upload_set_form_field \"__${upload_field_name}__is_composite\" \"true\";\n            upload_set_form_field \"__${upload_field_name}__keys\" \"name path\";\n            upload_set_form_field \"${upload_field_name}_name\" \"$upload_file_name\";\n            upload_set_form_field \"${upload_field_name}_path\" \"$upload_tmp_path\";\n            upload_pass_args on;\n            upload_pass /_upload_done;\n        }\n        location /_upload_done {\n            set $dst /api/tools;\n            if ($args ~ nginx_redir=([^&]+)) {\n                set $dst $1;\n            }\n            rewrite \"\" $dst;\n        }\n    }\n}\n```\n\nConfigure supervisord\n---------------------\n\n```console\ngalaxy@gcc2014:/opt/nginx/conf$ cd /etc/supervisor/conf.d\ngalaxy@gcc2014:/etc/supervisor/conf.d$ sudo vi galaxy.conf\n```\n\nIn the editor, paste:\n\n```ini\n[program:nginx]\ncommand\t\t= /opt/nginx/sbin/nginx\ndirectory\t= /\numask\t\t= 022\nautostart\t= true\nautorestart\t= unexpected\nstartsecs\t= 5\nexitcodes\t= 0\nuser\t\t= root\n\n[program:galaxy_uwsgi]\ncommand         = /usr/bin/uwsgi --plugin python --ini-paste /home/gxprod/galaxy-dist/universe_wsgi.ini\ndirectory       = /home/gxprod/galaxy-dist\numask           = 022\nautostart       = true\nautorestart     = true\nstartsecs       = 10\nuser            = gxprod\nenvironment     = PATH=/home/gxprod/venv:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin,PYTHON_EGG_CACHE=/home/gxprod/.python-eggs,PYTHONPATH=/home/gxprod/galaxy-dist/eggs/PasteDeploy-1.5.0-py2.7.egg\nnumprocs        = 1\nstopsignal      = INT\n\n[program:handler]\ncommand         = /home/gxprod/venv/bin/python ./scripts/paster.py serve universe_wsgi.ini --server-name=handler%(process_num)s --pid-file=/home/gxprod/handler%(process_num)s.pid --log-file=/home/gxprod/handler%(process_num)s.log\ndirectory       = /home/gxprod/galaxy-dist\nprocess_name    = handler%(process_num)s\nnumprocs        = 2\numask           = 022\nautostart       = true\nautorestart     = true\nstartsecs       = 15\nuser            = gxprod\nenvironment     = PYTHON_EGG_CACHE=/home/gxprod/.python-eggs,SGE_ROOT=/var/lib/gridengine\n\n[group:galaxy]\nprograms = handler\n```\n\nStart Galaxy and nginx\n----------------------\n\n```console\ngalaxy@gcc2014:/etc/supervisor/conf.d$ sudo supervisorctl update\ngalaxy_uwsgi: added process group\nhandler: added process group\nnginx: added process group\ngalaxy@gcc2014:/etc/supervisor/conf.d$ sudo supervisorctl status\ngalaxy:handler0                  STARTING\ngalaxy:handler1                  STARTING\ngalaxy_uwsgi                     STARTING\nnginx                            STARTING\n\n```\n\nYou can now visit your Galaxy server at - http://localhost/.\n\nReferences\n----------\n\n* [uWSGI](http://uwsgi-docs.readthedocs.org/en/latest/)\n* [Supervisor](http://supervisord.org/)\n\nLoad external data in a data library\n------------------------------------\n\nFirst, place some data in the import directory:\n\n```console\ngalaxy@gcc2014:~$ sudo -iu gxprod\ngxprod@gcc2014:~$ mkdir library/run1\ngxprod@gcc2014:~/library/run1$ cp galaxy-dist/test-data\n```\n\nNext, import the data in the Galaxy UI:\n\n* Register an account that matches the address you set in `admin_users`\n* Click **Admin** from the masthead\n* Click **Manage data libraries** from the left panel\n* Click **Create new data library**\n* Enter a Name and Description (and optionally a Synopsis) and click **Create**\n* Click **Add datasets**:\n* On the upload form:\n  * From the **Upload option:** menu, select **Upload directory of files**\n  * In the **File Format:** field, enter **fastqsanger**\n  * From **Server Directory**, select **run1**\n  * From the **Copy data into Galaxy?** menu, select **Link to files without copying into Galaxy**\n  * Click **Upload to library**\n* Click the **Shared Data** menu in the masthead and select **Data Libraries**\n* Click on the library you created\n* Select some datasets, then click **Go** to import them to your history\n\nGalaxy will use the data in its original location, and does not make additional copies for each user who imports the data. Access controls can be set on libraries and their contacts to limit them to certain users or groups.\n\nExtra Activities (Time and Interest Permitting)\n===============================================\n\nUsing Slurm or Torque/PBS\n-------------------------\n\nThe job configuration in `job_conf.xml` we used above included commented-out configurations for using Torque and Slurm. To use one of these other resource managers:\n\n```console\ngalaxy@gcc2014:~$ sudo -u gxprod vi ~gxprod/galaxy-dist/job_conf.xml\n  ... modify XML comments ...\ngalaxy@gcc2014:~$ sudo supervisorctl restart galaxy:*\n```\n\nShipping Jobs to Remote Resources with Pulsar\n---------------------------------------------\n\nPulsar (formerly called the LWR) allows Galaxy jobs to be staged to remote clusters without shared disk.\n\nWe only have one VM for this workshop - so we are going to simulate this by shipping `gxprod` jobs in the Galaxy instance we just configured back to a Pulsar server running as the `galaxy` user.\n\n### Installing Pulsar with Ansible\n\n```\ngalaxy@gcc2014:~$ . ansible/bin/activate\n(ansible)galaxy@gcc2014:~$ hg clone https://bitbucket.org/natefoo/galaxy-ansible\n(ansible)galaxy@gcc2014:~$ cd galaxy-ansible\n(ansible)galaxy@gcc2014:~/galaxy-ansible$ ansible-playbook -i localhost, local.yml -e \"pulsar_server_dir=/home/galaxy/pulsar pulsar_configure_galaxy=False galaxy_server_dir=/home/galaxy/galaxy-dist pulsar_private_token=puls0rt0ken\" --tags pulsar\n(ansible)galaxy@gcc2014:~/galaxy-ansible$ deactivate\ngalaxy@gcc2014:~/galaxy-ansible$ cd ~/pulsar\ngalaxy@gcc2014:~/pulsar$ ./run.sh -m paster --daemon\nEntering daemon mode\ngalaxy@gcc2014:~/pulsar$\n```\n\nNext up we will configure Galaxy to submit some jobs to this Pulsar server. Pulsar isn't available in Galaxy's `stable` branch yet however so we are going to checkout the `default` branch. (Older versions of Galaxy can target an LWR server for similar functionality - but we would encourage everyone to use Pulsar going forward.)\n\n```console\ngalaxy@gcc2014:~$ sudo -iu gxprod\ngxprod@gcc2014:~$ cd galaxy-dist/\ngxprod@gcc2014:~/galaxy-dist$ hg checkout default\n350 files updated, 0 files merged, 58 files removed, 0 files unresolved\ngxprod@gcc2014:~/galaxy-dist$ vi job_conf.xml\n```\n\nCopy the following contents - it routes one tool's jobs to the Pulsar server setup above.\n\n```xml\n<?xml version=\"1.0\"?>\n<job_conf>\n    <plugins workers=\"2\">\n        <plugin id=\"gridengine\" type=\"runner\" load=\"galaxy.jobs.runners.drmaa:DRMAAJobRunner\"/>\n\t<plugin id=\"pulsar_rest\" type=\"runner\" load=\"galaxy.jobs.runners.pulsar:PulsarRESTJobRunner\" />\n    </plugins>\n    <handlers default=\"handlers\">\n        <handler id=\"handler0\" tags=\"handlers\"/>\n        <handler id=\"handler1\" tags=\"handlers\"/>\n    </handlers>\n    <destinations default=\"gridengine\">\n        <destination id=\"gridengine\" runner=\"gridengine\"/>\n\t<destination id=\"local_pulsar\" runner=\"pulsar_rest\">\n\t  <param id=\"url\">http://localhost:8913/</param>\n\t  <param id=\"private_token\">puls0rt0ken</param>\n\t</destination>\n    </destinations>\n    <limits>\n        <limit type=\"registered_user_concurrent_jobs\">2</limit>\n        <limit type=\"unregistered_user_concurrent_jobs\">1</limit>\n        <limit type=\"job_walltime\">24:00:00</limit>\n    </limits>\n    <tools>\n      <tool id=\"cat1\" destination=\"local_pulsar\" />\n    </tools>\n</job_conf>\n```\n\nNow as the `galaxy` user restart the job handlers\n\n```console\ngxprod@gcc2014:~/galaxy-dist$ exit\ngalaxy@gcc2014:~$ sudo supervisorctl restart galaxy:*\n[sudo] password for galaxy:\nhandler0: stopped\nhandler1: stopped\nhandler0: started\nhandler1: started\n```\n\nOpen Galaxy, upload a file, and use the \"Concatenate Datasets\" tool on it to test Pulsar.\n\nAdditional topic candidates\n---------------------------\n\n* Dynamic job resource assignment\n\nTranscripts\n===========\n\nAdding local data by hand\n-------------------------\n\n```console\ngalaxy@gcc2014:~$ mkdir -p local_data/sacCer2/seq/work\ngalaxy@gcc2014:~$ cd local_data/sacCer2/seq/work\ngalaxy@gcc2014:~/local_data/sacCer2/seq/work$ wget http://hgdownload.cse.ucsc.edu/goldenPath/sacCer2/bigZips/chromFa.tar.gz\n--2014-06-29 14:09:25--  http://hgdownload.cse.ucsc.edu/goldenPath/sacCer2/bigZips/chromFa.tar.gz\nResolving hgdownload.cse.ucsc.edu (hgdownload.cse.ucsc.edu)... 128.114.119.163\nConnecting to hgdownload.cse.ucsc.edu (hgdownload.cse.ucsc.edu)|128.114.119.163|:80... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 3823174 (3.6M) [application/x-gzip]\nSaving to: â€˜chromFa.tar.gzâ€™\n\n100%[==================================================>] 3,823,174   1.01MB/s   in 4.3s\n\n2014-06-29 14:09:29 (859 KB/s) - â€˜chromFa.tar.gzâ€™ saved [3823174/3823174]\n\ngalaxy@gcc2014:~/local_data/sacCer2/seq/work$ tar zxvf chromFa.tar.gz\n2micron.fa\nchrI.fa\nchrII.fa\nchrIII.fa\nchrIV.fa\nchrIX.fa\nchrM.fa\nchrV.fa\nchrVI.fa\nchrVII.fa\nchrVIII.fa\nchrX.fa\nchrXI.fa\nchrXII.fa\nchrXIII.fa\nchrXIV.fa\nchrXV.fa\nchrXVI.fa\ngalaxy@gcc2014:~/local_data/sacCer2/seq/work$ cat *.fa >../sacCer2.fa\ngalaxy@gcc2014:~/local_data/sacCer2/seq/work$ cd ../..\ngalaxy@gcc2014:~/local_data/sacCer2$ mkdir bwa_index\ngalaxy@gcc2014:~/local_data/sacCer2$ cd bwa_index\ngalaxy@gcc2014:~/local_data/sacCer2/bwa_index$ ln -s ../seq/sacCer2.fa\ngalaxy@gcc2014:~/local_data/sacCer2/bwa_index$ ~/tool_deps/bwa/0.5.9/devteam/package_bwa_0_5_9/ec2595e4d313/bin/bwa index -a bwtsw sacCer2.fa\n[bwa_index] Pack FASTA... 0.18 sec\n[bwa_index] Reverse the packed sequence... 0.06 sec\n[bwa_index] Construct BWT for the packed sequence...\n[BWTIncConstructFromPacked] 10 iterations done. 2968163 characters processed.\n[BWTIncConstructFromPacked] 20 iterations done. 5189523 characters processed.\n[BWTIncConstructFromPacked] 30 iterations done. 6938035 characters processed.\n[BWTIncConstructFromPacked] 40 iterations done. 8313523 characters processed.\n[BWTIncConstructFromPacked] 50 iterations done. 9394739 characters processed.\n[BWTIncConstructFromPacked] 60 iterations done. 10243827 characters processed.\n[BWTIncConstructFromPacked] 70 iterations done. 10909811 characters processed.\n[BWTIncConstructFromPacked] 80 iterations done. 11431331 characters processed.\n[BWTIncConstructFromPacked] 90 iterations done. 11838867 characters processed.\n[BWTIncConstructFromPacked] 100 iterations done. 12156547 characters processed.\n[bwt_gen] Finished constructing BWT in 101 iterations.\n[bwa_index] 3.30 seconds elapse.\n[bwa_index] Construct BWT for the reverse packed sequence...\n[BWTIncConstructFromPacked] 10 iterations done. 2968163 characters processed.\n[BWTIncConstructFromPacked] 20 iterations done. 5189523 characters processed.\n[BWTIncConstructFromPacked] 30 iterations done. 6938035 characters processed.\n[BWTIncConstructFromPacked] 40 iterations done. 8313523 characters processed.\n[BWTIncConstructFromPacked] 50 iterations done. 9394739 characters processed.\n[BWTIncConstructFromPacked] 60 iterations done. 10243827 characters processed.\n[BWTIncConstructFromPacked] 70 iterations done. 10909811 characters processed.\n[BWTIncConstructFromPacked] 80 iterations done. 11431331 characters processed.\n[BWTIncConstructFromPacked] 90 iterations done. 11838867 characters processed.\n[BWTIncConstructFromPacked] 100 iterations done. 12156547 characters processed.\n[bwt_gen] Finished constructing BWT in 101 iterations.\n[bwa_index] 3.41 seconds elapse.\n[bwa_index] Update BWT... 0.08 sec\n[bwa_index] Update reverse BWT... 0.07 sec\n[bwa_index] Construct SA from BWT and Occ... 1.03 sec\n[bwa_index] Construct SA from reverse BWT and Occ... 1.02 sec\ngalaxy@gcc2014:~/local_data/sacCer2/bwa_index$ cd ~/galaxy-dist/tool-data\ngalaxy@gcc2014:~/galaxy-dist/tool-data$ vi bwa_index.loc\n  ...\n  sacCer2byhand   sacCer2 S. cerevisiae June 2008 (index by hand) /home/galaxy/local_data/sacCer2/bwa_index/sacCer2.fa\n  ...\ngalaxy@gcc2014:~/galaxy-dist/tool-data$ cd ..\ngalaxy@gcc2014:~/galaxy-dist$ vi tool_data_table_conf.xml\n  ...\n  <table name=\"bwa_indexes\" comment_char=\"#\">\n      <columns>value, dbkey, name, path</columns>\n      <file path=\"tool-data/bwa_index.loc\" />\n  </table>\n  ...\ngalaxy@gcc2014:~/galaxy-dist$ sh run.sh\n  ...\n```\n"}},"context":{}}