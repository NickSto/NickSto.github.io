{"hash":"4f66c62fb6940f4cd6ecf5e4a1e2d62361ec5ff4","data":{"article":{"id":"d0d347d81a14dbdcf1619f47f08817c4","title":"Nginx External User Authentication","tease":"","category":null,"date":null,"days":null,"contact":"","contact_url":"","fileInfo":{"path":"build/content-md/admin/config/nginx-external-user-auth/index.md"},"authors":"","location":"","location_url":"","source_blog":"","source_blog_url":"","skip_title_render":null,"redirect":"","autotoc":null,"links":[],"image":"","images":{},"external_url":"","content":"<div class=\"toc-wrapper col-md-3\">\n<ul>\n<li>\n<p><a href=\"#nginx-external-authentication\">Nginx External Authentication</a></p>\n<ul>\n<li>\n<p><a href=\"#generic-galaxy-configuration\">Generic Galaxy Configuration</a></p>\n<ul>\n<li><a href=\"#api-exception\">API Exception</a></li>\n</ul>\n</li>\n<li><a href=\"#pam\">PAM</a></li>\n<li><a href=\"#other\">Other</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<div class=\"body-wrapper col-md-9\">\n<h1 id=\"nginx-external-authentication\"><a href=\"#nginx-external-authentication\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Nginx External Authentication</h1>\n<p>By default, Galaxy manages its own users. However, it may be more useful at your site to tie into a local authentication system. Galaxy does not do this itself - it delegates this responsibility to the upstream proxy server.</p>\n<p>The setup for external authentication with nginx varies depending on your authentication methods. Modules exist for <a href=\"https://github.com/fintler/nginx-mod-auth-kerb\" target=\"_blank\" rel=\"noopener noreferrer\">Kerberos</a> and <a href=\"http://code.google.com/p/nginx-auth-ldap/\" target=\"_blank\" rel=\"noopener noreferrer\">LDAP</a> authentication, although those have not been tested.</p>\n<h2 id=\"generic-galaxy-configuration\"><a href=\"#generic-galaxy-configuration\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Generic Galaxy Configuration</h2>\n<div class=\"alert alert-warning\" role=\"alert\">\nThis section applies to all authentication methods.\n</div>\n<p>On the Galaxy side, set <code>use_remote_user = True</code> in <code>galaxy.ini</code>. If your auth method doesn't provide a full email address in <code>$(REMOTE_USER</code>, you'll also need to set <code>remote_user_maildomain</code>:</p>\n<pre><code>use_remote_user = True\nremote_user_maildomain = example.org\n</code></pre>\n<p>For example, when using basic authentication, only bare usernames (e.g. \"<code>nate</code>\") will be passed to Galaxy. Since Galaxy usernames are full email addresses, <code>remote_user_maildomain</code> needs to be set (e.g. to \"<code>example.org</code>\"). On the other hand, auth methods such as <code>mod_auth_kerb</code> set the full <code>nate@example.org</code> address, so <code>remote_user_maildomain</code> should not be set. If you're not sure, Galaxy will tell you via an error message if <code>remote_user_maildomain</code> needs to be set.</p>\n<p>Users are automatically created in the Galaxy database if the external auth method allows them through. Users created in this manner may not log in if <code>use_remote_user</code> is later disabled, since Galaxy does not have a password stored for the user (since the password is managed by the upstream proxy server.)</p>\n<h3 id=\"api-exception\"><a href=\"#api-exception\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>API Exception</h3>\n<p>If you wish your Galaxy to be accessible to command line clients (e.g. bioblend, blend4j, parsec), you will need to add an exception for authentication on the API. Galaxy will still be secure and protected, but non-browser access will be permitted with an API key. If this exception is not provided, many clients will throw errors as they are redirected to the login site under CAS type authentication, or rejected with unauthorized exception.</p>\n<pre><code class=\"language-nginx\">location /api {\n    auth_pam off;\n    allow all;\n    ...\n    proxy_pass http://galaxy_app;\n    ...\n}\n</code></pre>\n<h2 id=\"pam\"><a href=\"#pam\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>PAM</h2>\n<p>The <a href=\"https://en.wikipedia.org/wiki/Pluggable_authentication_module\" target=\"_blank\" rel=\"noopener noreferrer\">PAM</a> nginx authentication module has been used with success, and is suitable for use when you can use the system PAM stack to configure the valid authenticators. Most likely you'll need to recompile nginx to include your desired authentication module, as none of them are included by default.</p>\n<p>You'll need to set up your system's PAM stack, doing this is very site-specific depending on your authentication method, although if your //shell accounts// authenticate the same way as your //galaxy users// you can likely copy the PAM configuration. A PAM configuration that would be suitable for authentication with Kerberos (placed in <code>/etc/pam.d/nginx</code> might look like:</p>\n<pre><code>auth    [success=1 default=ignore]    pam_krb5.so minimum_uid=1000 ignore_k5login\nauth    requisite            pam_deny.so\nauth    required            pam_permit.so\n</code></pre>\n<p>Next, your nginx.conf should be modified like so:</p>\n<pre><code class=\"language-nginx\">location / {\n        auth_pam \"Basic Auth Realm Name\";\n        auth_pam_service_name \"nginx\";\n        proxy_pass http://galaxy_app;\n        proxy_set_header REMOTE_USER $remote_user;\n        proxy_set_header X-Forwarded-Host $host;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-URL-SCHEME https;\n}\n</code></pre>\n<p>The value of <code>auth_pam_service_name</code> must match the filename of the pam configuration you created in <code>/etc/pam.d/</code>.</p>\n<h2 id=\"other\"><a href=\"#other\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Other</h2>\n<p>If you have experience with other authentication stacks, please do not hesitate to share.</p>\n</div>\n"}},"context":{}}