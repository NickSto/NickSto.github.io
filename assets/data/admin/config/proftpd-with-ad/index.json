{"hash":"6a87f55bb3e5a997903b2c87cff72c00cc3c86c4","data":{"article":{"id":"853b84dc2e9d8531c5c89ae35facdfb8","title":"Setting up ProFTPd for galaxy uploads in an Active Directory environment","tease":"","image":"","images":{},"category":null,"contact":"","date":null,"content":"<ul>\n<li>You want to enable FTP file uploads?</li>\n<li>You are happy and able to use ProFTPd?</li>\n<li>You want to authenticate off Active Directory?</li>\n<li>You want Galaxy to actually find the uploaded files?</li>\n</ul>\n<p>Yes, Yes, Yes and Of_Course?  Read on..</p>\n<h2 id=\"some-background\"><a href=\"#some-background\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Some background</h2>\n<p>Galaxy grew up serving the entire internet and cannot assume a username is unique so it uses email-addresses as its user-names.</p>\n<p>Once an  \"ftp_upload_dir\"  is configured, it assumes that any uploaded files are to be found in the directory  \\&#x3C;ftp_upload_dir>/<email></p>\n<p>If it's empty or not there Galaxy reports, \"Your FTP upload directory contains no files.\"</p>\n<p>Galaxy checks every time you click Get Data : Upload File</p>\n<p>Galaxy exchanges no messages directly with the FTP server, if files are there, it shows them no matter how they got there.</p>\n<h2 id=\"assumptions\"><a href=\"#assumptions\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Assumptions</h2>\n<p>Your Galaxy serves a single institution with an AD domain and you're already using it to authenticate users in the Galaxy web pages.</p>\n<p>So your <code>config/galaxy.ini</code> file probably has lines like this in the section <code># Enable Galaxy's \"Upload via FTP\" interface.</code>:</p>\n<pre><code class=\"language-bash\"> use_remote_user = True\n remote_user_maildomain = example.domain\n ftp_upload_dir = /galaxy/database/ftp\n</code></pre>\n<p>Line 1 means you are already using remote (apache or nginx) authentication and that your users log in using their ident as their name not their email.</p>\n<p>Line 2 means Galaxy is appending a fixed string  \"@example.domain\"  to ALL users to convert from ident to email.</p>\n<p>Line 3 tells Galaxy to look in  \"/galaxy/database/ftp/<user>@example.domain\"</p>\n<h2 id=\"getting-a-version-of-proftpd-that-will-actually-do-what-it-says-it-will\"><a href=\"#getting-a-version-of-proftpd-that-will-actually-do-what-it-says-it-will\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Getting a version of ProFTPd that will actually do what it says it will</h2>\n<p>For this recipe to work will need at least these versions</p>\n<ul>\n<li>proftpd            version 1.3.4</li>\n<li>proftpd-mod-ldap   version 2.9.2   NOTE: Ubuntu-12.10 apt-get gives you version 2.9.0 which WILL NOT WORK!</li>\n</ul>\n<p>Go to :  <a href=\"http://horde.net/~jwm/software/mod_ldap/#current-release\" target=\"_blank\" rel=\"noopener noreferrer\">http://horde.net/~jwm/software/mod_ldap/#current-release</a></p>\n<h2 id=\"discussion\"><a href=\"#discussion\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Discussion</h2>\n<p>The functionality of defining where home dir is and creating it has just been moved from mod_ldap into proftpd itself.</p>\n<p>The extra functionality specifying it using a string containing %u is new to the internal proftpd.</p>\n<p>Using the versions specified and re-specifying the %u string to both proftpd and mod-ldap makes it not just accept the string but actually create the directory if it doesn't already exist.</p>\n<pre><code class=\"language-apache\"># This tells proftpd to create it if necessary and chroot to it\nDefaultRoot     \"/galaxy/database/ftp/%u@example.domain\"\nCreateHome              on 700\n\n# This tells mod_ldap the same thing\nLDAPGenerateHomedir     on 700\nLDAPGenerateHomedirPrefix \"/galaxy/database/ftp/%u@example.domain\"\nLDAPForceGeneratedHomedir on\nLDAPGenerateHomedirPrefixNoUsername     on\n</code></pre>\n<h2 id=\"configuring-proftpd\"><a href=\"#configuring-proftpd\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Configuring ProFTPd</h2>\n<p>Here is a commented more complete file from  /etc/proftpd/proftpd.conf</p>\n<pre><code class=\"language-apache\"># Load LDAP module\nLoadModule mod_ldap.c\n\n# Include some other modules\nInclude /etc/proftpd/modules.conf\n\n# Users require a valid shell listed in /etc/shells to login.\n# Use this directive to release that constrain.\nRequireValidShell       off\n\n# Set the user and group that the server normally runs at.\nUser                    galaxy\nGroup                   galaxy\n\n# Umask 022 is a good standard umask to prevent new files and dirs\n# (second parm) from being group and world writable.\nUmask                   137 027\n# Normally, we want files to be overwriteable.\nAllowOverwrite          on\n\n# Uncomment this if you are using NIS or LDAP via NSS to retrieve passwords:\n# PersistentPasswd      off\n\n# Galaxy users are not necessarily SSH users, so don't authenticate against real (system) users\nAuthPAM                 off\n\n# All authentication is via LDAP to AD\n#AuthOrder              mod_auth_pam.c* mod_auth_unix.c\nAuthOrder               mod_ldap.c\n\n# You MUST NOT use URL style LDAPServer\nLDAPServer      ad-server.example.domain:389\n\n# I can't get this to work, need to fiddle with certificates more\n#LDAPUseTLS on\n\n# You can map fields using LDAPAttr\n# LDAPAttr      expectedField   \"weird AD name with spaces and all sorts of crap\"\nLDAPAttr        homeDirectory   \"unixHomeDirectory\"\n\n# \nLDAPBindDN      \"CN=&#x3C;read-only-account>,OU=Special Accounts,DC=ad,DC=example,DC=domain\"    \"password\"\n\n# This defines the scope and search filter to find a user in AD\nLDAPUsers       \"OU=People,DC=ad,DC=example,DC=domain\"  \"(cn=%u)\"\n\n# With this LDAP re-binds to AD as the user using the password supplied\n# If it works, you're in!\nLDAPAuthBinds   on\n\nLDAPDefaultUID          \"&#x3C;uid-number-galaxy-is-running-as>\"\nLDAPDefaultGID          \"&#x3C;gid-number-galaxy-is-running-as>\"\n\n# Force those numbers even if LDAP finds a valid UID/GID\nLDAPForceDefaultUID     on\nLDAPForceDefaultGID     on\n\nLDAPGenerateHomedir     on 700\nLDAPGenerateHomedirPrefix \"/galaxy/database/ftp/%u@example.domain\"\n\n# Force this homedir even if LDAP said something different\nLDAPForceGeneratedHomedir on\n\n# The username is already incorporated in the %u, use this or it will get appended again\nLDAPGenerateHomedirPrefixNoUsername     on\n\n\nTransferLog             /var/log/proftpd/xferlog\nSystemLog               /var/log/proftpd/proftpd.log\n\n\n# You need this or users will get their passwords exposed across the network in the clear\nInclude /etc/proftpd/tls.conf\n\n# These \"virtuals\" allow more than 1 proftpd\n#       to run on the same host using different IPs.\n#Include /etc/proftpd/virtuals.conf\n\n# Cause every FTP user to be \"jailed\" (chrooted) into their home directory\nDefaultRoot     \"/galaxy/database/ftp/%u@example.com\"\n\n# Automatically create home directory if it doesn't exist\nCreateHome              on 700\n\n# Allow users to overwrite their files\nAllowOverwrite          on\n\n# Allow users to resume interrupted uploads\nAllowStoreRestart       on\n</code></pre>\n<h2 id=\"discussion-1\"><a href=\"#discussion-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Discussion</h2>\n<p>Where ever it's getting the information mod_ldap is looking for:</p>\n<ul>\n<li>uid</li>\n<li>gid</li>\n<li>uidNumber</li>\n<li>gidNumber</li>\n<li>homeDirectory</li>\n</ul>\n<h2 id=\"configuring-proftpd-with-openldap\"><a href=\"#configuring-proftpd-with-openldap\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Configuring ProFTPD with OpenLDAP</h2>\n<p>Helena Rasche found a set of working options for using ProFTPD with OpenLDAP\nservers (instead of AD).</p>\n<p>This configuration file can be modified and placed in\n<code>/etc/proftpd/conf.d/galaxy.conf</code></p>\n<p>Using the /conf.d/ directory, you can allow the ProFTPd to serve both\nlocal users (with PAM authentication) in the main configuration file,\nAND galaxy users on another port.</p>\n<pre><code class=\"language-apache\">&#x3C;VirtualHost xxx.yyy.zzz>\n        RequireValidShell       off\n        User                    galaxy\n        Group                   galaxy\n        Umask                   137 027\n        AllowOverwrite          on\n\n        # Ensure auth is LDAP\n        AuthPAM                 off\n        AuthOrder               mod_ldap.c\n\n        # Serve this VirtualHost on port 4000\n        Port                    4000\n\n        # LDAP Bind information\n        LDAPServer              ldaps://xxx.yyy.zzz/??sub\n        LDAPUsers               \"ou=People,dc=yyy,dc=zzz\"  \"(uid=%u)\"\n        LDAPAuthBinds           on\n\n        # Force those numbers even if LDAP finds a valid UID/GID\n        LDAPDefaultUID          1003\n        LDAPDefaultGID          1003\n        LDAPForceDefaultUID     on\n        LDAPForceDefaultGID     on\n\n        # Please generate home dir with user/group rwx permissions. Could probably be stricter\n        CreateHome              on 770\n        LDAPGenerateHomedir     on 770\n\n        # Force this homedir even if LDAP said something different\n        LDAPForceGeneratedHomedir               on\n        LDAPGenerateHomedirPrefix               \"/home/galaxy/galaxy/database/ftp/%u@cpt.tamu.edu\"\n\n        # The username is already incorporated in the %u, use this or it will get appended again\n        LDAPGenerateHomedirPrefixNoUsername     on\n\n        TransferLog             /var/log/proftpd/xfer-galaxy.log\n\n        # Cause every FTP user to be \"jailed\" (chrooted) into their home directory\n        DefaultRoot             \"/home/galaxy/galaxy/database/ftp/%u@cpt.tamu.edu\"\n        # Allow users to resume interrupted uploads\n        AllowStoreRestart       on\n        # I set these as my passive ports because I run a very strict firewall. Change as needed\n        PassivePorts            49152 50000\n&#x3C;/VirtualHost>\n</code></pre>\n<p>Notably, this configuration allows a galaxy virtualhost to coexist with\nthe normal FTP capabilities provided by ProFTPd, so users can still\naccess their home directories AND galaxy users can upload to galaxy.\nAuthentication can of course be changed to suit one's needs.</p>\n<h2 id=\"tls-configuration\"><a href=\"#tls-configuration\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>TLS Configuration</h2>\n<p>If you're running the galaxy FTP portion under a VirtualHost, like\ndescribed above, you'll notice that TLS directives placed in the main\nproftpd.conf file do not apply to VirtualHosts. As such, you can add a\nsection that looks like this to every VirtualHost that needs to be secured</p>\n<pre><code class=\"language-apache\">&#x3C;IfModule mod_tls.c>\n        TLSEngine                       on\n        TLSLog                          /var/log/proftpd/tls.galaxy.log\n        # Your cert and private key\n        TLSRSACertificateFile           /etc/ssl/certs/my.crt\n        TLSRSACertificateKeyFile        /etc/ssl/private/my.key\n        TLSCACertificateFile            /etc/ssl/certs/ca.bundle\n        # I've found that this is required for FileZilla\n        TLSOptions    NoCertRequest EnableDiags NoSessionReuseRequired\n        # Most clients won't be sending certs\n        TLSVerifyClient                 off\n        TLSRequired                     on\n&#x3C;/IfModule>\n</code></pre>\n"}},"context":{}}