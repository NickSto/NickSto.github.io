{"hash":"4f66c62fb6940f4cd6ecf5e4a1e2d62361ec5ff4","data":{"article":{"id":"f2ee6fefb17f206a974b5940f1499575","title":"","tease":"","category":null,"date":null,"days":null,"contact":"","contact_url":"","fileInfo":{"path":"build/content-md/admin/config/access-control/index.md"},"authors":"","location":"","location_url":"","source_blog":"","source_blog_url":"","skip_title_render":null,"redirect":"","autotoc":null,"links":[],"image":"","images":{},"external_url":"","content":"<div class=\"toc-wrapper col-md-3\">\n<ul>\n<li>\n<p><a href=\"#access-control\">Access control</a></p>\n<ul>\n<li>\n<p><a href=\"#disabling-tools\">Disabling tools</a></p>\n<ul>\n<li><a href=\"#job_confxml\">job_conf.xml</a></li>\n<li><a href=\"#destinationspy\">destinations.py</a></li>\n</ul>\n</li>\n<li><a href=\"#tool-visibility\">Tool Visibility</a></li>\n</ul>\n</li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n<li>\n<p><a href=\"#notes\">Notes</a></p>\n<ul>\n<li><a href=\"#multiple-worker-threads-running-local-jobs\">Multiple Worker Threads running local jobs</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<div class=\"body-wrapper col-md-9\">\n<h1 id=\"access-control\"><a href=\"#access-control\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Access control</h1>\n<p>Access control is an extremely important part of configuration if you are deploying tools that need to be restricted, whether it is due to licensing issues or to the tools have administrative functions.</p>\n<p>Restricting tool usage can be done in two levels</p>\n<ol>\n<li>Running of the tool can be restricted</li>\n<li>Tool visibility can be restricted</li>\n</ol>\n<h2 id=\"disabling-tools\"><a href=\"#disabling-tools\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Disabling tools</h2>\n<p>You can read a <a href=\"https://lists.galaxyproject.org/archives/list/galaxy-dev@lists.galaxyproject.org/thread/KVZ3FUDZBX4ZMPM6B5DMZ4TNYK4A6OPD/#QJ2LWTX2QGXQKX3XXFZCSAZCB7ZDCGIW\" target=\"_blank\" rel=\"noopener noreferrer\">thread</a> about restricting tool usage, but I will summarise the necessary changes here. Credit goes to Nicola Soranzo for illustrating this method of implementing tool access control.</p>\n<h3 id=\"job_confxml\"><a href=\"#job_confxml\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>job_conf.xml</h3>\n<p>Here is an example job_conf.xml file taken from that email thread</p>\n<pre><code class=\"language-xml\">&#x3C;?xml version=\"1.0\"?>\n&#x3C;job_conf>\n    &#x3C;plugins workers=\"4\">\n        &#x3C;plugin id=\"local\" type=\"runner\"\nload=\"galaxy.jobs.runners.local:LocalJobRunner\" />\n        &#x3C;plugin id=\"drmaa\" type=\"runner\"\nload=\"galaxy.jobs.runners.drmaa:DRMAAJobRunner\" />\n    &#x3C;/plugins>\n    &#x3C;handlers>\n        &#x3C;handler id=\"main\"/>\n    &#x3C;/handlers>\n    &#x3C;destinations default=\"remote_cluster\">\n        &#x3C;destination id=\"local\" runner=\"local\" />\n        &#x3C;destination id=\"transcriptome_role\" runner=\"dynamic\">\n            &#x3C;param id=\"function\">is_user_in_role&#x3C;/param>\n        &#x3C;/destination>\n        &#x3C;destination id=\"remote_cluster\" runner=\"drmaa\" /> \n    &#x3C;/destinations>\n    &#x3C;tools>\n        &#x3C;tool id=\"tool1\" destination=\"transcriptome_role\"\nrequired_role=\"transcriptome_users\" final_destination=\"local\"/>\n    &#x3C;/tools>\n&#x3C;/job_conf>\n</code></pre>\n<p>If you've already edited the job_conf.xml file, you are enough familiar with it to adapt the changes to your needs. (If you have not used job_conf before but <em>are</em> using multiple worker threads, see the notes at the end.)</p>\n<p>There are two important sections in here, firstly the destination a job will be sent to. Galaxy gives you the ability to route jobs however you wish. In this example case we'll look at restricting the use of transcriptome analysis tools so our users don't kill our server.</p>\n<pre><code class=\"language-xml\" id=\"transcriptome_role\">&#x3C;destination id=\"transcriptome_role\" runner=\"dynamic\">\n    &#x3C;param id=\"function\">is_user_in_role&#x3C;/param>\n&#x3C;/destination>\n</code></pre>\n<p>This define a dynamic destination, called <code>transcriptome_role</code>, which will use the Python function indicated in <code>&#x3C;param id=\"function\"></code>, i.e. <code>is_user_in_role</code>. The source code of this function should be placed in a file (e.g. destinations.py) inside lib/galaxy/jobs/rules/ , as noted in <a href=\"http://wiki.galaxyproject.org/Admin/Config/Jobs#Dynamic_Destination_Mapping\" target=\"_blank\" rel=\"noopener noreferrer\">Galaxy Job Configuration</a>. It is a bit of code that can raise exceptions and modify job parameters that are passed through it. We'll cover the code there, shortly.</p>\n<p>The other important portion of the config file is the tool-to-destination mapping.</p>\n<pre><code class=\"language-xml\" id=\"tool1\">&#x3C;tools>\n    &#x3C;tool id=\"tool1\" destination=\"transcriptome_role\"\nrequired_role=\"transcriptome_users\" final_destination=\"local\"/>\n&#x3C;/tools>\n</code></pre>\n<p>In this XML snippet we've set <code>tool1</code> to go to the destination referenced by id <code>transcriptome_role</code>. We've provided some extra parameters, namely <code>required_role</code> and <code>final_destination</code> which are not part of the <code>job_config.xml</code> specification, if you read it closely. The extra XML tags and values will be used by the <code>is_user_in_role</code> function.</p>\n<h3 id=\"destinationspy\"><a href=\"#destinationspy\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>destinations.py</h3>\n<p>In the <code>destinations.py</code> script we handle how the tool gets routed and the behaviour. Here is an example script.</p>\n<pre><code class=\"language-python\">from galaxy.jobs.mapper import JobMappingException\nDEFAULT_ROLE = 'have_license'\n\ndef is_user_in_role(user, app, tool):\n    # user is a galaxy.model.User object or None\n    # app is a galaxy.app.UniverseApplication object\n    # tool is a galaxy.tools.Tool object\n    if user is None:\n        raise JobMappingException('You must login to use this tool!')\n    # Determine required_role and final_destination for tool_id tool\n    # job_conf.xml syntax:\n    # &#x3C;tool id=\"tool_id\" destination=\"is_user_in_role\" required_role=\"special_users\" final_destination=\"special_queue\"/>\n    # Both required_role and final_destination attributes are optional.\n    default_destination_id = app.job_config.get_destination(None)\n    # Loop across all of the job_tool_configurations which apply to the tool in question\n    for jtc in tool.job_tool_configurations:\n        # tool.job_tool_configurations is a list of galaxy.jobs.JobToolConfiguration objects\n        if not jtc.params:\n            # We attempt to extract the required_role and final_destination variables from the &#x3C;tool> XML element\n            required_role = jtc.get('required_role', DEFAULT_ROLE)\n            final_destination = jtc.get('final_destination', default_destination_id)\n            break\n    else:\n        required_role = DEFAULT_ROLE\n        final_destination = default_destination_id\n    # Check that the required_role is in the set of role names associated with the user\n    user_roles = user.all_roles() # a list of galaxy.model.Role objects\n    user_in_role = required_role in [role.name for role in user_roles]\n    if not user_in_role:\n        raise JobMappingException(\"This tool is restricted to users associated with the '%s' role, please contact a site administrator to be authorized!\" % required_role)\n    else:\n        return final_destination\n</code></pre>\n<p>At this point you can restart your Galaxy instance and you will be able to verify that your tool is restricted from use by anyone not associated with your specified role.</p>\n<h2 id=\"tool-visibility\"><a href=\"#tool-visibility\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Tool Visibility</h2>\n<p>The second item to restricting tool visibility is by adding in a <a href=\"http://wiki.galaxyproject.org/UserDefinedToolboxFilters#For_Administrators\" target=\"_blank\" rel=\"noopener noreferrer\">dynamic toolbox filter</a>.</p>\n<p>\\&#x3C;!>  Filters will only hide Tools from the User Interface, they are still available and can be made visible by means of HTML manipulation. That said these feature is not a security feature, it is intended to separate multiple groups of tools and simplify the ToolBox.</p>\n<p>You can look at <code>lib/galaxy/tools/toolbox/filters/examples.py</code> for good examples of filters. For our example we'll restrict all sections with the word \"Admin\" in them. This is an easy way to sequester administrative tools for admins only.</p>\n<pre><code class=\"language-python\">import logging\nlog = logging.getLogger( __name__ )\n\ndef admin( context, section ):\n    \"\"\"\n    Disable Admin sections: disable all Tools groups under a 'Admin' section when enabled.\n    \"\"\"\n    # If the section contains the word admin\n    if section.name.find('Admin') != -1:\n        return context.trans.user_is_admin()\n    return True\n</code></pre>\n<p>To rewrite the important points from <a href=\"/user-defined-toolbox-filters/\">UserDefinedToolboxFilters</a> page,</p>\n<ul>\n<li>Every filter is a small python function under lib/galaxy/tools/toolbox/filters/.</li>\n<li>Return False to NOT display the tool</li>\n<li>Return True to display the tool</li>\n</ul>\n<p>There are several different types of filters:</p>\n<ul>\n<li>section</li>\n<li>label</li>\n<li>tool</li>\n</ul>\n<p>Each of these passes appropriate variables to the python function when they're called, and as such their declaration in the main configuration is slightly different. To activate a filter, you will need to modify your <code>config/galaxy.yml</code> file. The syntax for each of them is spread across several examples in the <code>examples.py</code> file that is provided. These are reproduced below for clarity</p>\n<ul>\n<li><code>tool_filters: 'examples:restrict_upload_to_admins'</code></li>\n<li><code>tool_section_filters: 'examples:explicit_user_mapping'</code></li>\n<li><code>tool_label_filters: 'examples:label_filter'</code></li>\n</ul>\n<p>Simply add the appropriate string to your <code>config/galaxy.yml</code> to activate a tool filter.</p>\n<h1 id=\"conclusion\"><a href=\"#conclusion\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Conclusion</h1>\n<p>With this, you should have restricted a tool's use to a specific role, and hidden that tool/section of tools to a specific group. This is enough to implement most ACLs that you would wish to implement in Galaxy, whether you are restricting a tool due to licensing constraints (e.g., GATK example in <code>examples.py</code>), due to administrative functionality, or for developer testing before public release.</p>\n<h1 id=\"notes\"><a href=\"#notes\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Notes</h1>\n<h2 id=\"multiple-worker-threads-running-local-jobs\"><a href=\"#multiple-worker-threads-running-local-jobs\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Multiple Worker Threads running local jobs</h2>\n<p>If you have not used the job_conf before and are using multiple worker threads for running galaxy (e.g., <code>server:handler0</code> entries in your <code>config/galaxy.yml</code>), please be sure to note you'll have to modify your <code>&#x3C;handlers></code> section to look something like:</p>\n<pre><code class=\"language-xml\">&#x3C;handlers default=\"handlers\">\n    &#x3C;handler id=\"handler0\" tags=\"handlers\" />\n    ...etc\n</code></pre>\n</div>\n"}},"context":{}}