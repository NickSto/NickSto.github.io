{"hash":"14e186fd360947c1255e65c919a062692f477385","data":{"article":{"id":"b033af1b29daf206f69cd90fa824950e","title":"","tease":"","skip_title_render":null,"image":"","images":{},"contact":"","inserts":[{"name":"/admin/tools/linkbox","content":"<div class='linkbox'>\n**[Galaxy Tools](/src/tools/index.md)**\n----\n[Install from ToolShed](/src/admin/tools/add-tool-from-toolshed-tutorial/index.md)<br />\n[Create Custom Tool](/src/admin/tools/add-tool-tutorial/index.md)<br />\n[Complete Tool Syntax](/src/admin/tools/tool-config-syntax/index.md)<br />\n<hr>\n<p><strong><a href=\"/toolshed/\">Galaxy ToolShed</a></strong><br />\n<a href=\"/toolshed/publish-tool/\">Publishing Tools</a><br />\n<a href=\"/iuc/\">Utilities Commission</a><br />\n<a href=\"/toolshed/hosting-a-local-toolshed/\">Hosting Tool Shed</a><br /></p>\n</div>\n"}],"date":null,"content":"<slot name=\"/admin/tools/linkbox\" />\n## Writing Tests\n\nPreparing test for your Galaxy tool is easy. In short you include a sample input file and asample output file. Then you specify the parameters that with the given tool and input should produce the desired output.\n\nEverybody benefits from a good testing - the tool author ensures quality of tool, admins can easily separate good tools from bad tools and users use tools that are reliable. An examples below explains how to write a test.\n\nTests can be specified in the tool config file using `<tests>` and `test` tags (for more information see [ description of test configuration tags](/admin/tools/tool-config-syntax/).  For example, the [cluster tool](https://github.com/galaxyproject/tools-devteam/blob/master/tool_collections/gops/cluster/cluster.xml) specifies the following tests:\n\n```xml\n  <tests>\n    <test>\n      <param name=\"input1\" value=\"5.bed\" />\n      <param name=\"distance\" value=\"1\" />\n      <param name=\"minregions\" value=\"2\" />\n      <param name=\"returntype\" value=\"1\" />\n      <output name=\"output\" file=\"gops-cluster-1.bed\" />     \n    </test>\n    <test>\n      <param name=\"input1\" value=\"gops_cluster_bigint.bed\" />\n      <param name=\"distance\" value=\"1\" />\n      <param name=\"minregions\" value=\"2\" />\n      <param name=\"returntype\" value=\"1\" />\n      <output name=\"output\" file=\"gops-cluster-1.bed\" />     \n    </test>\n    <test>\n      <param name=\"input1\" value=\"5.bed\" />\n      <param name=\"distance\" value=\"1\" />\n      <param name=\"minregions\" value=\"2\" />\n      <param name=\"returntype\" value=\"2\" />\n      <output name=\"output\" file=\"gops-cluster-2.bed\" />     \n    </test>    \n    <test>\n      <param name=\"input1\" value=\"5.bed\" />\n      <param name=\"distance\" value=\"1\" />\n      <param name=\"minregions\" value=\"2\" />\n      <param name=\"returntype\" value=\"3\" />\n      <output name=\"output\" file=\"gops-cluster-3.bed\" />     \n    </test>\n  </tests>\n```\n\nTo explain what this means let's first take a look at the inputs and outputs of the [cluster tool](https://github.com/galaxyproject/tools-devteam/blob/master/tool_collections/gops/cluster/cluster.xml). It takes four inputs (`input1`, `distance`, `minregions`, and `returntype`) and produces a single `output`:\n\n```xml\n  <inputs>\n    <param format=\"interval\" name=\"input1\" type=\"data\">\n      <label>Cluster intervals of</label>\n    </param>\n    <param name=\"distance\" size=\"5\" type=\"integer\" value=\"1\" help=\"(bp)\">\n      <label>max distance between intervals</label>\n    </param>\n    <param name=\"minregions\" size=\"5\" type=\"integer\" value=\"2\">\n      <label>min number of intervals per cluster</label>\n    </param>\n\t<param name=\"returntype\" type=\"select\" label=\"Return type\">\n\t\t<option value=\"1\">Merge clusters into single intervals</option>\n\t\t<option value=\"2\">Find cluster intervals; preserve comments and order</option>\n\t\t<option value=\"3\">Find cluster intervals; output grouped by clusters</option>\n\t\t<option value=\"4\">Find the smallest interval in each cluster</option>\n\t\t<option value=\"5\">Find the largest interval in each cluster</option>\n\t</param>\n   </inputs>\n  <outputs>\n    <data format=\"input\" name=\"output\" metadata_source=\"input1\" />\n  </outputs>\n```\n\nNow let's take a look at the first test:\n\n```xml\n    <test>\n      <param name=\"input1\" value=\"5.bed\" />\n      <param name=\"distance\" value=\"1\" />\n      <param name=\"minregions\" value=\"2\" />\n      <param name=\"returntype\" value=\"1\" />\n      <output name=\"output\" file=\"gops-cluster-1.bed\" />     \n    </test>\n```\n\nAll this does is specify parameters that will be used by test framework to run this test. For most input types, the value should be what would be entered by the user when running the tool through the web, with the exception of input and output. The input (`5.bed`) and output (`gops-cluster-1.bed`) files reside within the `~/test-data` directory. Once the test is executed the framework simply compares generated output with an example file (`gops-cluster-1.bed` in this case). If there are no differences - test is declared success.\n\nTo run the Galaxy functional tests see [Running Tests](/admin/running-tests/).\n\n---\n\nAdvanced Test Settings\n----------------------\n\n### Output File Comparison Methods\n\n#### diff\n\nThe default comparison method (*diff*) simply compares line by line in a file to check if the result of the test run of the tool matches the expected output specified in the `<output>` tag. A *lines_diff* attribute can be provided to allow the declared number of lines to differ between outputs. A 'change' in a line is equivalent to a count of 2 line differences: one line removed, one line added.\n\n```\n    <test>\n      <output name=\"output\" file=\"variable_output_file.bed\" lines_diff=\"10\"/>     \n    </test>\n```\n\nSeveral tools, including those that use Composite Datatypes such as rGenetics, create additional files which are stored in a directory associated with the main history item. If you have a tool that creates these extra files, it is a good idea to write tests which also verify their correctness. This can be done on a per extra file basis or by comparing an entire directory; all of the previously mentioned comparison methods are applicable.\n\nThe two examples below are from `tools/peak_calling/macs_wrapper.xml`.\n\n#### File-by-file comparison\n\nHere two outputs are being tested; the first file has no extra files, but the second file has five extra files (in addition to the primary file) which are being tested.\n\n```\n    <test>\n      <output name=\"output_bed_file\" file=\"peakcalling_macs/macs_test_1_out.bed\" />\n      <output name=\"output_html_file\" file=\"peakcalling_macs/macs_test_1_out.html\" compare=\"re_match\" >\n        <extra_files type=\"file\" name=\"Galaxy_Test_Run_model.pdf\" value=\"peakcalling_macs/test2/Galaxy_Test_Run_model.pdf\" compare=\"re_match\"/>\n        <extra_files type=\"file\" name=\"Galaxy_Test_Run_model.r\" value=\"peakcalling_macs/test2/Galaxy_Test_Run_model.r\" compare=\"re_match\"/>\n        <extra_files type=\"file\" name=\"Galaxy_Test_Run_model.r.log\" value=\"peakcalling_macs/test2/Galaxy_Test_Run_model.r.log\"/>\n        <extra_files type=\"file\" name=\"Galaxy_Test_Run_negative_peaks.xls\" value=\"peakcalling_macs/test2/Galaxy_Test_Run_negative_peaks.xls\" compare=\"re_match\"/>\n        <extra_files type=\"file\" name=\"Galaxy_Test_Run_peaks.xls\" value=\"peakcalling_macs/test2/Galaxy_Test_Run_peaks.xls\" compare=\"re_match\"/>\n      </output>\n    </test>\n```\n\n#### Directory comparison\n\nHere four outputs are being tested; the first three files have no extra files, but the last file has 5 extra files (in addition to the primary file) which are being tested by the directory method. Each file in the specified directory of *output_html_file* will be tested against the files of the same name in the history item's extra files path.\n\n```\n    <test>\n      <output name=\"output_bed_file\" file=\"peakcalling_macs/macs_test_1_out.bed\" />\n      <output name=\"output_xls_to_interval_peaks_file\" file=\"peakcalling_macs/macs_test_2_peaks_out.interval\" lines_diff=\"4\" />\n      <output name=\"output_xls_to_interval_negative_peaks_file\" file=\"peakcalling_macs/macs_test_2_neg_peaks_out.interval\" />\n      <output name=\"output_html_file\" file=\"peakcalling_macs/macs_test_1_out.html\" compare=\"re_match\" >\n        <extra_files type=\"directory\" value=\"peakcalling_macs/test2/\" compare=\"re_match\"/>\n      </output>\n    </test>\n```\n\n---\n\nBeware of twill bug\n-------------------\n\nSee the following e-mail for explanation of a workaround that deals with \"dashed\" options:\n\n```\nHello Assaf,\n\nThis is a known bug in twill 0.9.  The work-around is to use the label rather than the value in your functional test.  So, in your example, the test should be changed to the following.  Let me know if this does not work.\n\nOne of the tests looks like this:\n-------------\n<test>\n  <!-- ASCII to NUMERIC -->\n  <param name=\"input\" value=\"fastq_qual_conv1.fastq\" />\n  <param name=\"QUAL_FORMAT\" value=\"Numeric quality scores\" />\n  <output name=\"output\" file=\"fastq_qual_conv1.out\" />\n</test>\n-------------\n\nGreg Von Kuster\nGalaxy Development Team\n\n\nAssaf Gordon wrote:\nHello,\n\nI wrote a functional test for my tool, and encountered a strange behavior.\n\nOne of the tool's parameters looks like this:\n-------------\n<param name=\"QUAL_FORMAT\" type=\"select\" label=\"output format\">\n     <option value=\"-a\">ASCII (letters) quality scores</option>\n     <option value=\"-n\">Numeric quality scores</option>\n</param>\n------------\n\nOne of the tests looks like this:\n-------------\n<test>\n   <!-- ASCII to NUMERIC -->\n   <param name=\"input\" value=\"fastq_qual_conv1.fastq\" />\n   <param name=\"QUAL_FORMAT\" value=\"-n\" />\n   <output name=\"output\" file=\"fastq_qual_conv1.out\" />\n</test>\n-------------\n\n\nWhen I run the functional tests for this tool, I get the following exception:\n---------------\nTraceback (most recent call last):\nFile \"galaxy_devel_tools/test/functional/test_toolbox.py\", line 114, in test_tool\n    self.do_it()\nFile \"galaxy_devel_tools/test/functional/test_toolbox.py\", line 44, in do_it\n    self.run_tool( self.testdef.tool.id, repeat_name=repeat_name, **page_inputs )\nFile \"galaxy_devel_tools/test/base/twilltestcase.py\", line 520, in run_tool\n    self.submit_form( **kwd )\n  File \"galaxy_devel_tools/test/base/twilltestcase.py\", line 495, in submit_form\n    raise AssertionError( errmsg )\nAssertionError: Attempting to set field 'QUAL_FORMAT' to value '['-n']' in form 'tool_form' threw exception: cannot find value/label \"n\" in list control\ncontrol: <SelectControl(QUAL_FORMAT=[-a, -n])>\n---------------\n\nIf I understand the exception correctly, it means that somewhere the minus character (\"-n\") gets dropped, and therefor the value 'n' cannot be found in the list (which contains \"-n\" and \"-a\").\n\n\n\nIs this an actual bug or am I doing something wrong?\n\nThanks,\n   Gordon.\n```\n\n---\n\nSaving generated functional test output files\n---------------------------------------------\n\nA small change to the test framework was introduced in April 2011 allowing test outputs generated by Twill during functional tests to be saved, making it easier to update test expected outputs after changes to a tool.\n\nIf there is a variable called 'GALAXY_TEST_SAVE' in the environment when tests are being run, each output file Twill generates that is compared with a reference file will be written to that directory - assuming write permissions and so on. For example:\n\n```\nsetenv GALAXY_TEST_SAVE /tmp/galtest\nsh run_functional_tests.sh -id myTool\n```\n\nwill test the individual tool with id 'myTool' and write the tested output files to /tmp/galtest. Running a full set of functional tests will of course result in a full set of test outputs being saved. To stop test outputs from being saved, reset GALAXY_TOOL_SAVE to null\n\n```\nsetenv GALAXY_TEST_SAVE\n```\n\nSee also the environment variable GALAXY_TEST_NO_CLEANUP which disables automated removal of the test output files.\n"}},"context":{}}